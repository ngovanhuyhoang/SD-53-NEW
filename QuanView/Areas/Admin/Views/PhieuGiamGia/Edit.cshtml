@model QuanApi.Data.PhieuGiamGia
@using QuanApi.Dtos

@{
    ViewData["Title"] = "Sửa phiếu giảm giá";
    var khachHangs = ViewBag.KhachHangs as List<KhachHangDto>;
    var selectedKhachHangId = ViewBag.SelectedKhachHangId as Guid?;
}

<h2>@ViewData["Title"]</h2>

<form asp-action="Edit" method="post">
    @Html.AntiForgeryToken()
    <input type="hidden" asp-for="IDPhieuGiamGia" />
    <input type="hidden" name="khachHangId" id="SelectedKhachHangId" value="@selectedKhachHangId" />

    <div class="form-group">
        <label asp-for="MaCode"></label>
        <input asp-for="MaCode" class="form-control" />
    </div>

    <div class="form-group">
        <label asp-for="TenPhieu"></label>
        <input asp-for="TenPhieu" class="form-control" />
    </div>

    <div class="form-group">
        <label asp-for="GiaTriGiam"></label>
        <input asp-for="GiaTriGiam" class="form-control" />
    </div>

    <div class="form-group">
        <label asp-for="GiaTriGiamToiDa"></label>
        <input asp-for="GiaTriGiamToiDa" class="form-control" />
    </div>

    <div class="form-group">
        <label asp-for="DonToiThieu"></label>
        <input asp-for="DonToiThieu" class="form-control" />
    </div>

    <div class="form-group">
        <label asp-for="SoLuong"></label>
        <input asp-for="SoLuong" class="form-control" />
    </div>

    <div class="form-group">
        <label asp-for="NgayBatDau"></label>
        <input asp-for="NgayBatDau" type="date" class="form-control" />
    </div>

    <div class="form-group">
        <label asp-for="NgayKetThuc"></label>
        <input asp-for="NgayKetThuc" type="date" class="form-control" />
    </div>

    <div class="form-group">
        <label for="LaCongKhai">Công khai?</label>
        <input type="checkbox" id="LaCongKhai" name="LaCongKhai" value="true" @(Model.LaCongKhai ? "checked" : "") onchange="toggleKhachHangTable()" />
    </div>

    <div id="chonKhachHang" style="display:none;">
        <h5>Chọn khách hàng áp dụng:</h5>
        <table class="table table-bordered table-hover">
            <thead>
                <tr>
                    <th>Tên khách hàng</th>
                    <th>Email</th>
                    <th>SĐT</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var kh in khachHangs)
                {
                    var isSelected = selectedKhachHangId.HasValue && selectedKhachHangId == kh.IDKhachHang;
                    <tr class="khach-row @(isSelected ? "table-primary" : "")"
                        data-id="@kh.IDKhachHang"
                        style="cursor:pointer">
                        <td>@kh.TenKhachHang</td>
                        <td>@kh.Email</td>
                        <td>@kh.SoDienThoai</td>
                    </tr>
                }
            </tbody>
        </table>
    </div>

    <div class="form-group">
        <label asp-for="TrangThai">Kích hoạt</label>
        <input asp-for="TrangThai" type="checkbox" />
    </div>

    <div class="form-group">
        <label asp-for="NguoiTao"></label>
        <input asp-for="NguoiTao" class="form-control" readonly />
    </div>

    <button type="submit" class="btn btn-primary">Lưu</button>
    <a asp-action="Index" class="btn btn-secondary">Quay lại</a>
</form>

@section Scripts {
    <script>
        function toggleKhachHangTable() {
            var isPublic = document.getElementById("LaCongKhai").checked;
            document.getElementById("chonKhachHang").style.display = isPublic ? "none" : "block";
        }

        document.addEventListener("DOMContentLoaded", function () {
            toggleKhachHangTable();

            document.querySelectorAll(".khach-row").forEach(row => {
                row.addEventListener("click", function () {
                    document.querySelectorAll(".khach-row").forEach(r => r.classList.remove("table-primary"));
                    row.classList.add("table-primary");
                    document.getElementById("SelectedKhachHangId").value = row.dataset.id;
                });
            });
        });
    </script>
}
