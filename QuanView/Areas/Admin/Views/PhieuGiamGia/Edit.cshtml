@model QuanApi.Data.PhieuGiamGia
@using QuanApi.Dtos

@{
    ViewData["Title"] = "Sửa phiếu giảm giá";
    var khachHangs = ViewBag.KhachHangs as List<KhachHangDto>;
    var selectedKhachHangId = ViewBag.SelectedKhachHangId as Guid?;
}

<h2>@ViewData["Title"]</h2>

<form asp-action="Edit" method="post">
    @Html.AntiForgeryToken()
    <input type="hidden" asp-for="IDPhieuGiamGia" />
    <input type="hidden" name="khachHangId" id="SelectedKhachHangId" value="@selectedKhachHangId" />

    <div class="form-group">
        <label asp-for="MaCode"></label>
        <input asp-for="MaCode" class="form-control" />
    </div>

    <div class="form-group">
        <label asp-for="TenPhieu"></label>
        <input asp-for="TenPhieu" class="form-control" />
    </div>

    <div class="form-group">
        <label asp-for="GiaTriGiam">Phần trăm giảm giá (%)</label>
        <input asp-for="GiaTriGiam" class="form-control" type="number" min="0" max="100" />
        <small class="form-text text-muted">Nhập phần trăm giảm giá từ 0 đến 100%</small>
    </div>

    <div class="form-group">
        <label asp-for="GiaTriGiamToiDa">Giá trị giảm tối đa (VNĐ)</label>
        <input asp-for="GiaTriGiamToiDa" class="form-control" type="number" min="0" />
        <small class="form-text text-muted">Giá trị tiền tối đa được giảm (để trống nếu không giới hạn)</small>
    </div>

    <div class="form-group">
        <label asp-for="DonToiThieu">Đơn hàng tối thiểu (VNĐ)</label>
        <input asp-for="DonToiThieu" class="form-control" type="number" min="0" />
        <small class="form-text text-muted">Giá trị đơn hàng tối thiểu để áp dụng phiếu giảm giá</small>
    </div>

    <div class="form-group">
        <label asp-for="SoLuong"></label>
        <input asp-for="SoLuong" class="form-control" />
    </div>

    <div class="form-group">
        <label asp-for="NgayBatDau"></label>
        <input asp-for="NgayBatDau" type="date" class="form-control" />
    </div>

    <div class="form-group">
        <label asp-for="NgayKetThuc"></label>
        <input asp-for="NgayKetThuc" type="date" class="form-control" />
    </div>

    <div class="form-group">
        <label>
            <input type="checkbox" id="LaCongKhai" name="LaCongKhai" value="true" @(Model.LaCongKhai ? "checked" : "") onchange="toggleCustomerSelection()" />
            Công khai (áp dụng cho tất cả khách hàng - mỗi người 1 phiếu)
        </label>
        <small class="form-text text-info">Khi chọn công khai, tất cả khách hàng sẽ được nhận 1 phiếu giảm giá mỗi người, bất kể số lượng cấu hình.</small>
    </div>

    <div id="customerSelectionSection" style="display:@(Model.LaCongKhai ? "none" : "block");">
        <div class="form-group">
            <label>
                <input type="checkbox" id="TaoRiengCheckbox" name="TaoRieng" value="true" @(selectedKhachHangId.HasValue ? "checked" : "") onchange="toggleKhachHangTable()" />
                Tạo riêng cho khách hàng cụ thể
            </label>
        </div>
        
        <div id="chonKhachHang" style="display:@(selectedKhachHangId.HasValue ? "block" : "none");">
            <h5>Chọn khách hàng áp dụng:</h5>
            <table class="table table-bordered table-hover">
                <thead>
                    <tr>
                        <th>Tên khách hàng</th>
                        <th>Email</th>
                        <th>SĐT</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var kh in khachHangs)
                    {
                        var isSelected = selectedKhachHangId.HasValue && selectedKhachHangId == kh.IDKhachHang;
                        <tr class="khach-row @(isSelected ? "table-primary" : "")"
                            data-id="@kh.IDKhachHang"
                            style="cursor:pointer">
                            <td>@kh.TenKhachHang</td>
                            <td>@kh.Email</td>
                            <td>@kh.SoDienThoai</td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    </div>

    <div class="form-group">
        <label asp-for="TrangThai">Kích hoạt</label>
        <input asp-for="TrangThai" type="checkbox" />
    </div>

    <div class="form-group">
        <label asp-for="NguoiTao"></label>
        <input asp-for="NguoiTao" class="form-control" readonly />
    </div>

    <button type="submit" class="btn btn-primary">Lưu</button>
    <a asp-action="Index" class="btn btn-secondary">Quay lại</a>
</form>

@section Scripts {
    <script>
        function toggleCustomerSelection() {
            var isPublic = document.getElementById("LaCongKhai").checked;
            document.getElementById("customerSelectionSection").style.display = isPublic ? "none" : "block";
            
            if (isPublic) {
                document.getElementById("SelectedKhachHangId").value = "";
            }
        }

        function toggleKhachHangTable() {
            var taoRieng = document.getElementById("TaoRiengCheckbox").checked;
            document.getElementById("chonKhachHang").style.display = taoRieng ? "block" : "none";
            
            if (!taoRieng) {
                document.getElementById("SelectedKhachHangId").value = "";
            }
        }

        document.addEventListener("DOMContentLoaded", function () {
            document.querySelectorAll(".khach-row").forEach(row => {
                row.addEventListener("click", function () {
                    document.querySelectorAll(".khach-row").forEach(r => r.classList.remove("table-primary"));
                    row.classList.add("table-primary");
                    document.getElementById("SelectedKhachHangId").value = row.dataset.id;
                });
            });
        });
    </script>
}
