@model QuanApi.Dtos.CreatePhieuGiamGiaDto
@using QuanApi.Dtos

@{
    ViewData["Title"] = "Tạo phiếu giảm giá";
    var khachHangs = ViewBag.KhachHangs as List<KhachHangDto>;
}

<h2>@ViewData["Title"]</h2>

@if (!ViewData.ModelState.IsValid)
{
    <div class="alert alert-danger">
        <ul>
            @foreach (var error in ViewData.ModelState.Values.SelectMany(v => v.Errors))
            {
                <li>@error.ErrorMessage</li>
            }
        </ul>
    </div>
}

<form asp-action="Create" method="post">
    @Html.AntiForgeryToken()

    <div class="form-group">
        <label asp-for="MaCode"></label>
        <input asp-for="MaCode" class="form-control" />
        <span asp-validation-for="MaCode" class="text-danger"></span>
    </div>

    <div class="form-group">
        <label asp-for="TenPhieu"></label>
        <input asp-for="TenPhieu" class="form-control" />
        <span asp-validation-for="TenPhieu" class="text-danger"></span>
    </div>

    <div class="form-group">
        <label asp-for="GiaTriGiam">Phần trăm giảm giá (%)</label>
        <input asp-for="GiaTriGiam" class="form-control" type="number" min="0" max="100" />
        <small class="form-text text-muted">Nhập phần trăm giảm giá từ 0 đến 100%</small>
        <span asp-validation-for="GiaTriGiam" class="text-danger"></span>
    </div>

    <div class="form-group">
        <label asp-for="GiaTriGiamToiDa">Giá trị giảm tối đa (VNĐ)</label>
        <input asp-for="GiaTriGiamToiDa" class="form-control" type="number" min="0" />
        <small class="form-text text-muted">Giá trị tiền tối đa được giảm (để trống nếu không giới hạn)</small>
        <span asp-validation-for="GiaTriGiamToiDa" class="text-danger"></span>
    </div>

    <div class="form-group">
        <label asp-for="DonToiThieu">Đơn hàng tối thiểu (VNĐ)</label>
        <input asp-for="DonToiThieu" class="form-control" type="number" min="0" />
        <small class="form-text text-muted">Giá trị đơn hàng tối thiểu để áp dụng phiếu giảm giá</small>
        <span asp-validation-for="DonToiThieu" class="text-danger"></span>
    </div>

    <div class="form-group">
        <label asp-for="SoLuong"></label>
        <input asp-for="SoLuong" class="form-control" />
        <span asp-validation-for="SoLuong" class="text-danger"></span>
    </div>

    <div class="form-group">
        <label asp-for="NgayBatDau"></label>
        <input asp-for="NgayBatDau" type="date" class="form-control" />
        <span asp-validation-for="NgayBatDau" class="text-danger"></span>
    </div>

    <div class="form-group">
        <label asp-for="NgayKetThuc"></label>
        <input asp-for="NgayKetThuc" type="date" class="form-control" />
        <span asp-validation-for="NgayKetThuc" class="text-danger"></span>
    </div>

    <div class="form-group">
        <label>
            <input type="checkbox" id="LaCongKhai" name="LaCongKhai" value="true" onchange="toggleCustomerSelection()" />
            Công khai (áp dụng cho tất cả khách hàng - mỗi người 1 phiếu)
        </label>
        <small class="form-text text-info">Khi chọn công khai, tất cả khách hàng sẽ được nhận 1 phiếu giảm giá mỗi người, bất kể số lượng cấu hình.</small>
    </div>

    <div id="customerSelectionSection" style="display:none;">
        <div class="form-group">
            <label>
                <input type="checkbox" id="TaoRiengCheckbox" name="TaoRieng" value="true" onchange="toggleKhachHangTable()" />
                Tạo riêng cho khách hàng cụ thể
            </label>
        </div>
        
        <input type="hidden" name="khachHangId" id="SelectedKhachHangId" value="" />
        
        <div id="chonKhachHang" style="display:none;">
            <h5>Chọn khách hàng áp dụng:</h5>
            <table class="table table-bordered table-hover">
                <thead>
                    <tr>
                        <th>Tên khách hàng</th>
                        <th>Email</th>
                        <th>SĐT</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var kh in khachHangs)
                    {
                        <tr class="khach-row" data-id="@kh.IDKhachHang" style="cursor:pointer">
                            <td>@kh.TenKhachHang</td>
                            <td>@kh.Email</td>
                            <td>@kh.SoDienThoai</td>
                        </tr>
                    }
                </tbody>
            </table>
            
            <div id="guiEmailDiv" style="display:none;" class="form-group mt-2">
                <label>
                    <input type="checkbox" id="GuiEmailCheckbox" name="GuiEmail" value="true" />
                    Gửi email thông báo cho khách hàng này?
                </label>
            </div>
        </div>
    </div>

    <div class="form-group mt-2">
        <label asp-for="TrangThai">Kích hoạt</label>
        <input asp-for="TrangThai" type="checkbox" />
    </div>

    <div class="form-group">
        <label asp-for="NguoiTao"></label>
        <input asp-for="NguoiTao" class="form-control" readonly />
        <span asp-validation-for="NguoiTao" class="text-danger"></span>
    </div>

    <button type="submit" class="btn btn-primary">Tạo phiếu</button>
    <a asp-action="Index" class="btn btn-secondary">Quay lại</a>
</form>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />
    <script>
        function toggleCustomerSelection() {
            const laCongKhai = document.getElementById("LaCongKhai").checked;
            const customerSection = document.getElementById("customerSelectionSection");
            
            if (laCongKhai) {
                customerSection.style.display = "none";
                document.getElementById("SelectedKhachHangId").value = "";
                document.getElementById("guiEmailDiv").style.display = "none";
            } else {
                customerSection.style.display = "block";
            }
        }

        function toggleKhachHangTable() {
            const taoRieng = document.getElementById("TaoRiengCheckbox").checked;
            document.getElementById("chonKhachHang").style.display = taoRieng ? "block" : "none";
            if (!taoRieng) {
                document.getElementById("SelectedKhachHangId").value = "";
                document.getElementById("guiEmailDiv").style.display = "none";
            }
        }

        document.addEventListener("DOMContentLoaded", function () {
            toggleCustomerSelection();
            toggleKhachHangTable();

            document.querySelectorAll(".khach-row").forEach(row => {
                row.addEventListener("click", function () {
                    document.querySelectorAll(".khach-row").forEach(r => r.classList.remove("table-primary"));
                    row.classList.add("table-primary");

                    document.getElementById("SelectedKhachHangId").value = row.dataset.id;
                    document.getElementById("guiEmailDiv").style.display = "block";
                });
            });
        });
    </script>
}
