@{
    ViewBag.Title = "B√°n h√†ng";
}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" />
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">

<style>
    /* Toast Notification Styles */
    .toast-container {
        position: fixed;
        top: 20px;
        right: 20px;
        z-index: 9999;
        max-width: 350px;
    }
    
    .custom-toast {
        background: white;
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        margin-bottom: 10px;
        overflow: hidden;
        transform: translateX(400px);
        transition: all 0.3s ease;
        border-left: 4px solid #28a745;
    }
    
    .custom-toast.show {
        transform: translateX(0);
    }
    
    .custom-toast.success {
        border-left-color: #28a745;
    }
    
    .custom-toast.error {
        border-left-color: #dc3545;
    }
    
    .custom-toast.warning {
        border-left-color: #ffc107;
    }
    
    .custom-toast.info {
        border-left-color: #17a2b8;
    }
    
    .toast-header {
        padding: 12px 16px;
        display: flex;
        align-items: center;
        justify-content: space-between;
        border-bottom: 1px solid #e9ecef;
    }
    
    .toast-icon {
        width: 20px;
        height: 20px;
        margin-right: 8px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-size: 12px;
    }
    
    .toast-icon.success {
        background-color: #28a745;
    }
    
    .toast-icon.error {
        background-color: #dc3545;
    }
    
    .toast-icon.warning {
        background-color: #ffc107;
    }
    
    .toast-icon.info {
        background-color: #17a2b8;
    }
    
    .toast-title {
        font-weight: 600;
        font-size: 14px;
        color: #333;
        flex: 1;
    }
    
    .toast-close {
        background: none;
        border: none;
        font-size: 18px;
        color: #999;
        cursor: pointer;
        padding: 0;
        width: 20px;
        height: 20px;
        display: flex;
        align-items: center;
        justify-content: center;
    }
    
    .toast-close:hover {
        color: #666;
    }
    
    .toast-body {
        padding: 12px 16px;
        font-size: 13px;
        color: #666;
        line-height: 1.4;
    }
    
    .toast-progress {
        height: 3px;
        background-color: rgba(0,0,0,0.1);
        position: relative;
        overflow: hidden;
    }
    
    .toast-progress-bar {
        height: 100%;
        background-color: currentColor;
        width: 100%;
        transform: translateX(-100%);
        transition: transform linear;
    }
    
    .custom-toast.success .toast-progress-bar {
        background-color: #28a745;
    }
    
    .custom-toast.error .toast-progress-bar {
        background-color: #dc3545;
    }
    
    .custom-toast.warning .toast-progress-bar {
        background-color: #ffc107;
    }
    
    .custom-toast.info .toast-progress-bar {
        background-color: #17a2b8;
    }

    /* CSS cho dropdown ƒë·ªãa ch·ªâ esgoo.net */
    .css_select_div { 
        text-align: left;
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
    }
    .css_select { 
        flex: 1;
        min-width: 200px;
        padding: 8px 12px;
        border: 1px solid #ddd;
        border-radius: 6px;
        font-size: 14px;
        background-color: white;
        transition: border-color 0.3s;
    }
    .css_select:focus {
        border-color: #007bff;
        box-shadow: 0 0 0 0.2rem rgba(0,123,255,0.25);
        outline: none;
    }
    .css_select:disabled {
        background-color: #f8f9fa;
        color: #6c757d;
    }
    @@media (max-width: 768px) {
        .css_select_div {
            flex-direction: column;
        }
        .css_select {
            min-width: 100%;
        }
    }

    /* CSS cho modal ƒë·ªãa ch·ªâ */
    .address-card {
        transition: all 0.3s ease;
        border: 2px solid #e9ecef;
        cursor: pointer;
    }

    .address-card:hover {
        border-color: #007bff;
        box-shadow: 0 2px 8px rgba(0,123,255,0.15);
        transform: translateY(-1px);
    }

    .address-card.selected {
        border-color: #007bff;
        background-color: #f8f9ff;
    }
</style>

<div class="container mt-3">
    <div class="d-flex justify-content-between align-items-center mb-2">
        <ul class="nav nav-tabs" id="invoiceTabs"></ul>
        <button class="btn btn-primary" id="btnAddInvoice">+ T·∫°o gi·ªè h√†ng</button>
    </div>
    <div class="d-flex justify-content-end mb-2">
        @* <button class="btn btn-info me-2" id="btnQRCode">QR Code</button> *@
        <button class="btn btn-success" id="btnAddProduct">Th√™m s·∫£n ph·∫©m</button>
    </div>
    <div id="invoiceContent"></div>
    
    <!-- Toast Container -->
    <div class="toast-container" id="toastContainer"></div>
    <div class="row mt-4">
        <div class="col-md-7">
            <div class="card mb-3">
                <div class="card-header fw-bold">T√†i kho·∫£n</div>
                <div class="card-body" id="accountInfo">
                    <div class="mb-2">
                        <span class="fw-bold">T√™n kh√°ch h√†ng:</span>
                        <span id="customerName" class="badge bg-secondary">kh√°ch l·∫ª</span>
                    </div>
                    <div id="customerDetails" style="display:none;">
                        <div><span class="fw-bold">S·ªë ƒëi·ªán tho·∫°i:</span> <span id="customerPhone"></span></div>
                        <div><span class="fw-bold">email:</span> <span id="customerEmail"></span></div>
                    </div>
                    <button class="btn btn-outline-secondary btn-sm mt-2" onclick="showCustomerModal()">Ch·ªçn t√†i kho·∫£n</button>
                    <button class="btn btn-outline-danger btn-sm mt-2 ms-2" id="btnClearCustomer" style="display:none;" onclick="clearCustomer()" title="H·ªßy ch·ªçn kh√°ch h√†ng">
                        <i class="bi bi-x-circle"></i> H·ªßy ch·ªçn
                    </button>
                    <button class="btn btn-outline-secondary btn-sm mt-2 float-end" id="btnShowAddress" style="display:none;" onclick="focusAddressForm()">Ch·ªçn ƒë·ªãa ch·ªâ</button>
                <button class="btn btn-outline-primary btn-sm mt-2 me-2 float-end" id="btnAddAddress" style="display:none;" onclick="openSaveAddressModal()">L∆∞u ƒë·ªãa ch·ªâ</button>
                </div>
            </div>

            <!-- Form nh·∫≠p ƒë·ªãa ch·ªâ giao h√†ng -->
            <div class="card mb-3" id="shippingFormCard" style="display:none;">
                <div class="card-header fw-bold">Kh√°ch h√†ng</div>
                <div class="card-body">
                    <div class="mb-2">
                        <input type="text" class="form-control" id="shipName" placeholder="Nh·∫≠p h·ªç v√† t√™n">
                    </div>
                    <div class="mb-2">
                        <input type="text" class="form-control" id="shipPhone" placeholder="Nh·∫≠p s·ªë ƒëi·ªán tho·∫°i">
                    </div>
                    <div class="mb-2">
                        <input type="email" class="form-control" id="shipEmail" placeholder="Nh·∫≠p email">
                    </div>
                    <div class="mb-2">
                        <label class="form-label">ƒê·ªãa ch·ªâ giao h√†ng <span class="text-danger">*</span></label>
                        <div class="d-flex gap-2 mb-2">
                            <button type="button" class="btn btn-outline-secondary btn-sm" onclick="clearAddressForm()">
                                <i class="fa fa-eraser"></i> X√≥a form
                            </button>
                        </div>
                        
                        <!-- Dropdown ch·ªçn t·ªânh th√†nh, qu·∫≠n huy·ªán, ph∆∞·ªùng x√£ cho form ch√≠nh -->
                        <div class="css_select_div mb-3">
                            <select class="css_select form-control" id="shipTinh" name="shipTinh" title="Ch·ªçn T·ªânh Th√†nh">
                                <option value="0">T·ªânh Th√†nh</option>
                            </select> 
                            <select class="css_select form-control" id="shipQuan" name="shipQuan" title="Ch·ªçn Qu·∫≠n Huy·ªán">
                                <option value="0">Qu·∫≠n Huy·ªán</option>
                            </select> 
                            <select class="css_select form-control" id="shipPhuong" name="shipPhuong" title="Ch·ªçn Ph∆∞·ªùng X√£">
                                <option value="0">Ph∆∞·ªùng X√£</option>
                            </select>
                        </div>
                        
                        <!-- ƒê·ªãa ch·ªâ chi ti·∫øt -->
                        <input type="text" class="form-control mb-2" id="shipDiaChiChiTiet" name="shipDiaChiChiTiet" placeholder="S·ªë nh√†, t√™n ƒë∆∞·ªùng...">
                        
                        <!-- ƒê·ªãa ch·ªâ ƒë·∫ßy ƒë·ªß (readonly) -->
                        <textarea class="form-control" id="shipAddress" rows="3" readonly placeholder="ƒê·ªãa ch·ªâ ƒë·∫ßy ƒë·ªß s·∫Ω hi·ªÉn th·ªã ·ªü ƒë√¢y"></textarea>
                    </div>
                   @*  <div class="row mb-2">
                        <div class="col">
                            <select class="form-select" id="shipProvince">
                                <option>Ch·ªçn t·ªânh</option>
                            </select>
                        </div>
                        <div class="col">
                            <select class="form-select" id="shipDistrict">
                                <option>Ch·ªçn Qu·∫≠n</option>
                            </select>
                        </div>
                        <div class="col">
                            <select class="form-select" id="shipWard">
                                <option>Ch·ªçn Ph∆∞·ªùng x√£</option>
                            </select>
                        </div>
                    </div> *@
                    <div class="mb-2">
                        <input type="text" class="form-control" id="shipNote" placeholder="Ghi ch√∫">
                    </div>
                    <div class="mb-2">
                        <button type="button" class="btn btn-outline-primary btn-sm" onclick="saveAddressToCustomer()">
                            <i class="bi bi-save"></i> L∆∞u ƒë·ªãa ch·ªâ cho kh√°ch h√†ng
                        </button>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-5">
            <div class="card">
                <div class="card-header fw-bold"><i class="bi bi-bag"></i> Th√¥ng tin thanh to√°n</div>
                <div class="card-body">
                    <div class="mb-2">
                        <span>Ti·ªÅn h√†ng:</span>
                        <span class="float-end" id="goodsAmount">0 VND</span>
                    </div>
                    <div class="mb-2">
                        <label class="form-label">Ph√≠ v·∫≠n chuy·ªÉn:</label>
                        <input type="number" class="form-control" id="shippingFee" value="0" min="0" readonly />
                        <small class="text-muted">Ph√≠ v·∫≠n chuy·ªÉn c·ªë ƒë·ªãnh: 50.000 VNƒê</small>
                    </div>
                 
                    <div class="mb-2">
                        <label class="form-label">M√£ gi·∫£m gi√°:</label>
                        <div class="input-group">
                            <input type="text" class="form-control" id="discountCode" value="" placeholder="Ch·ªçn phi·∫øu gi·∫£m gi√°" readonly>
                            <button class="btn btn-outline-secondary" type="button" onclick="applyDiscount()">Ch·ªçn m√£</button>
                            <button class="btn btn-outline-danger" type="button" onclick="clearDiscount()" title="X√≥a phi·∫øu gi·∫£m gi√°">
                                <i class="bi bi-x-lg"></i>
                            </button>
                        </div>
                    </div>
                    <div class="form-check form-switch mb-2">
                        <input class="form-check-input" type="checkbox" id="shippingSwitch" onchange="toggleShipping()">
                        <label class="form-check-label" for="shippingSwitch">Giao H√†ng</label>
                    </div>
                     <div class="mb-2">
                    <span>Kh√°ch c·∫ßn thanh to√°n</span>
    <span class="float-end fw-bold" id="payAmount">0 VND</span>
</div>
                
                    <div class="mb-2">
                        <span>Ti·ªÅn th·ªëi l·∫°i:</span>
                        <span class="float-end fw-bold text-success" id="changeAmount">0 VND</span>
                    </div>
                    <div class="mb-2">
                        <span>Gi·∫£m gi√°:</span>
                        <span class="float-end text-success" id="discountAmount">0 VND</span>
                    </div>
                  @*   <div class="form-check form-switch mb-2">
                        <input class="form-check-input" type="checkbox" id="pointSwitch" onchange="togglePoint()">
                        <label class="form-check-label" for="pointSwitch">ƒêi·ªÉm hi·ªán t·∫°i l√† <span id="customerPoint">0</span>:</label>
                    </div> *@
                    <div class="mb-2 d-flex align-items-center">
    <span>H√¨nh th·ª©c thanh to√°n:</span>
    <span class="ms-auto d-flex align-items-center">
        <span id="selectedPaymentMethod">Ti·ªÅn m·∫∑t</span>
        <a href="javascript:void(0)" onclick="openPaymentModal()" class="ms-2" title="Ch·ªânh s·ª≠a">
            <i class="bi bi-pencil-square" style="font-size: 1.2em; cursor: pointer;"></i>
        </a>
    </span>
</div>
                    <div class="mb-2">
                        <span class="fw-bold">T·ªïng ti·ªÅn:</span>
                        <span class="float-end fw-bold text-danger" id="totalAmount">0 VND</span>
                    </div>
                   <button class="btn btn-primary w-100" onclick="payInvoice()">Thanh to√°n</button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal ch·ªçn s·∫£n ph·∫©m -->
<div class="modal fade" id="productModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Ch·ªçn s·∫£n ph·∫©m</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="productList">
                <!-- Danh s√°ch s·∫£n ph·∫©m s·∫Ω ƒë∆∞·ª£c load ·ªü ƒë√¢y -->
            </div>
        </div>
    </div>
</div>

<!-- Modal ch·ªçn kh√°ch h√†ng -->
<div class="modal fade" id="customerModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Kh√°ch h√†ng</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <input type="text" class="form-control mb-2" id="searchCustomer" placeholder="T√¨m ki·∫øm theo s·ªë ƒëi·ªán tho·∫°i, t√™n">
                <button class="btn btn-primary mb-2" onclick="searchCustomer()">T√¨m ki·∫øm</button>
                <table class="table table-bordered">
                    <thead>
                        <tr>
                            <th>STT</th>
                            <th>·∫¢nh</th>
                            <th>T√™n kh√°ch h√†ng</th>
                            <th>Email</th>
                            <th>S·ªë ƒëi·ªán tho·∫°i</th>
                            <th>ƒêi·ªÉm</th>
                            <th>H√†nh ƒë·ªông</th>
                        </tr>
                    </thead>
                    <tbody id="customerList"></tbody>
                </table>
                <button class="btn btn-secondary" data-bs-dismiss="modal">H·ªßy</button>
                <button class="btn btn-success float-end" onclick="addNewCustomer()">Th√™m kh√°ch h√†ng</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal x√°c nh·∫≠n thanh to√°n -->
<div class="modal fade" id="confirmPaymentModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Thanh to√°n</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-2">
                    <span>S·ªë ti·ªÅn ph·∫£i thanh to√°n:</span>
                    <span class="float-end fw-bold" id="modalPayAmount">0 ƒë</span>
                </div>
                <div class="mb-2">
                    <label class="form-label">H√¨nh th·ª©c thanh to√°n</label>
                    <select class="form-select" id="paymentMethod">
                        <!-- Option s·∫Ω ƒë∆∞·ª£c load ƒë·ªông t·ª´ API -->
                    </select>
                </div>
                <div class="mb-2">
                    <label class="form-label">Ti·ªÅn kh√°ch ƒë∆∞a</label>
                    <input type="number" class="form-control" id="modalCustomerPaid" min="0" value="0" oninput="updateModalChangeAmount()" />
                </div>
                <div class="mb-2">
                    <span>Ti·ªÅn th·ªëi l·∫°i:</span>
                    <span class="float-end fw-bold text-success" id="modalChangeAmount">0 ƒë</span>
                </div>
                <!-- C√≥ th·ªÉ th√™m b·∫£ng l·ªãch s·ª≠ giao d·ªãch n·∫øu c·∫ßn -->
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" data-bs-dismiss="modal">H·ªßy b·ªè</button>
                <button class="btn btn-primary" onclick="updatePaymentInfoFromModal()">X√°c nh·∫≠n</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal ch·ªçn phi·∫øu gi·∫£m gi√° -->
<div class="modal fade" id="discountVoucherModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Ch·ªçn phi·∫øu gi·∫£m gi√°</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="voucherList">
                    <!-- Danh s√°ch phi·∫øu gi·∫£m gi√° s·∫Ω ƒë∆∞·ª£c load ·ªü ƒë√¢y -->
                </div>
                <div id="noVoucherMessage" style="display:none;" class="text-center py-4">
                    <i class="bi bi-ticket-perforated" style="font-size: 3rem; color: #ccc;"></i>
                    <p class="mt-2 text-muted">Kh√°ch h√†ng ch∆∞a c√≥ phi·∫øu gi·∫£m gi√° n√†o</p>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" data-bs-dismiss="modal">ƒê√≥ng</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal t·∫°o ƒë·ªãa ch·ªâ m·ªõi -->
<div class="modal fade" id="addAddressModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Th√™m ƒë·ªãa ch·ªâ m·ªõi</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="addAddressForm">
                    <div class="mb-3">
                        <label class="form-label">T√™n ng∆∞·ªùi nh·∫≠n</label>
                        <input type="text" class="form-control" id="newAddressName" placeholder="Nh·∫≠p t√™n ng∆∞·ªùi nh·∫≠n">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">S·ªë ƒëi·ªán tho·∫°i</label>
                        <input type="text" class="form-control" id="newAddressPhone" placeholder="Nh·∫≠p s·ªë ƒëi·ªán tho·∫°i">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">ƒê·ªãa ch·ªâ chi ti·∫øt</label>
                        <textarea class="form-control" id="newAddressDetail" rows="3" placeholder="Nh·∫≠p ƒë·ªãa ch·ªâ chi ti·∫øt (s·ªë nh√†, ƒë∆∞·ªùng, ph∆∞·ªùng, qu·∫≠n, t·ªânh/th√†nh ph·ªë)"></textarea>
                    </div>
                    <div class="mb-3">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="newAddressDefault">
                            <label class="form-check-label" for="newAddressDefault">
                                ƒê·∫∑t l√†m ƒë·ªãa ch·ªâ m·∫∑c ƒë·ªãnh
                            </label>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">H·ªßy</button>
                <button type="button" class="btn btn-primary" onclick="createNewAddress()">T·∫°o ƒë·ªãa ch·ªâ</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal ch·ªçn ƒë·ªãa ch·ªâ -->
<div class="modal fade" id="selectAddressModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Ch·ªçn ƒë·ªãa ch·ªâ giao h√†ng</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <button type="button" class="btn btn-outline-primary btn-sm" onclick="openAddAddressModal()">
                        <i class="bi bi-plus-circle"></i> Th√™m ƒë·ªãa ch·ªâ m·ªõi
                    </button>
                </div>
                <div id="addressList">
                    <!-- Danh s√°ch ƒë·ªãa ch·ªâ s·∫Ω ƒë∆∞·ª£c load ·ªü ƒë√¢y -->
                </div>
                <div id="noAddressMessage" style="display:none;" class="text-center py-4">
                    <i class="bi bi-geo-alt" style="font-size: 3rem; color: #ccc;"></i>
                    <p class="mt-2 text-muted">Kh√°ch h√†ng ch∆∞a c√≥ ƒë·ªãa ch·ªâ n√†o</p>
                    <button type="button" class="btn btn-primary" onclick="openAddAddressModal()">
                        <i class="bi bi-plus-circle"></i> Th√™m ƒë·ªãa ch·ªâ ƒë·∫ßu ti√™n
                    </button>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">H·ªßy</button>
            </div>
        </div>
    </div>
</div>

<script>
    let gioHangs = [];
    let currentGioHang = 0;
    const maxGioHangs = 5;

    // D·ªØ li·ªáu ƒë·ªông
    let products = [];
    let customers = [];
    let selectedCustomer = null;
    let discountValue = 0; // Gi√° tr·ªã gi·∫£m gi√° hi·ªán t·∫°i
    let useShipping = false; // C√≥ s·ª≠ d·ª•ng giao h√†ng kh√¥ng
    let usePoint = false;
    let selectedPaymentCode;
    let shippingFee = 0;

    // Toast Notification System
    function showToast(message, type = 'success', duration = 4000) {
        const toastContainer = document.getElementById('toastContainer');
        const toastId = 'toast_' + Date.now();
        
        const icons = {
            success: '‚úì',
            error: '‚úï',
            warning: '‚ö†',
            info: '‚Ñπ'
        };
        
        const titles = {
            success: 'Th√†nh c√¥ng',
            error: 'L·ªói',
            warning: 'C·∫£nh b√°o',
            info: 'Th√¥ng tin'
        };
        
        const toast = document.createElement('div');
        toast.id = toastId;
        toast.className = `custom-toast ${type}`;
        toast.innerHTML = `
            <div class="toast-header">
                <div class="toast-icon ${type}">${icons[type] || icons.info}</div>
                <div class="toast-title">${titles[type] || titles.info}</div>
                <button class="toast-close" onclick="closeToast('${toastId}')">&times;</button>
            </div>
            <div class="toast-body">${message}</div>
            <div class="toast-progress">
                <div class="toast-progress-bar"></div>
            </div>
        `;
        
        toastContainer.appendChild(toast);
        
        // Trigger animation
        setTimeout(() => {
            toast.classList.add('show');
        }, 10);
        
        // Start progress bar animation
        const progressBar = toast.querySelector('.toast-progress-bar');
        setTimeout(() => {
            progressBar.style.transition = `transform ${duration}ms linear`;
            progressBar.style.transform = 'translateX(0)';
        }, 100);
        
        // Auto remove
        setTimeout(() => {
            closeToast(toastId);
        }, duration);
        
        return toastId;
    }
    
    function closeToast(toastId) {
        const toast = document.getElementById(toastId);
        if (toast) {
            toast.style.transform = 'translateX(400px)';
            toast.style.opacity = '0';
            setTimeout(() => {
                if (toast.parentNode) {
                    toast.parentNode.removeChild(toast);
                }
            }, 300);
        }
    }
    
    // Convenience functions
    function showSuccess(message, duration = 4000) {
        return showToast(message, 'success', duration);
    }
    
    function showError(message, duration = 5000) {
        return showToast(message, 'error', duration);
    }
    
    function showWarning(message, duration = 4500) {
        return showToast(message, 'warning', duration);
    }
    
    function showInfo(message, duration = 4000) {
        return showToast(message, 'info', duration);
    }

    // Load s·∫£n ph·∫©m t·ª´ API
    function loadProducts(callback) {
        $.get('/Admin/ClientBanHangTaiQuay/danh-sach-san-pham', function(data) {
            products = data;
            if (callback) callback();
        });
    }

    // Load kh√°ch h√†ng t·ª´ API
    function loadCustomers(callback) {
        $.get('/Admin/ClientBanHangTaiQuay/danh-sach-khach-hang', function(data) {
            customers = data;
            if (callback) callback();
        });
    }

    // T√¨m ki·∫øm kh√°ch h√†ng
    function searchCustomer() {
        let q = $('#searchCustomer').val();
        if (!q) {
            renderCustomerList(customers);
            return;
        }
        $.get('/Admin/ClientBanHangTaiQuay/tim-kiem-khach-hang', { query: q }, function(data) {
            renderCustomerList(data);
        });
    }

    // Th√™m kh√°ch h√†ng m·ªõi
    function addNewCustomer() {
        let name = prompt('Nh·∫≠p t√™n kh√°ch h√†ng m·ªõi:');
        let phone = prompt('Nh·∫≠p s·ªë ƒëi·ªán tho·∫°i kh√°ch h√†ng:');
        if (!name || !phone) return showWarning('Vui l√≤ng nh·∫≠p ƒë·ªß th√¥ng tin!');
        $.ajax({
            url: '/Admin/ClientBanHangTaiQuay/them-khach-hang',
            method: 'POST',
            contentType: 'application/json',
            data: JSON.stringify({ tenKhachHang: name, soDienThoai: phone }),
            success: function(res) {
                loadCustomers(function() {
                    renderCustomerList(customers);
                });
                showSuccess('Th√™m kh√°ch h√†ng th√†nh c√¥ng!');
            },
            error: function(err) {
                showWarning('Th√™m kh√°ch h√†ng th·∫•t b·∫°i!');
            }
        });
    }

    // √Åp d·ª•ng m√£ gi·∫£m gi√°
    function applyDiscount() {
        if (!selectedCustomer) {
            showWarning('Vui l√≤ng ch·ªçn kh√°ch h√†ng tr∆∞·ªõc khi ch·ªçn phi·∫øu gi·∫£m gi√°!');
            return;
        }
        
        // Load danh s√°ch phi·∫øu gi·∫£m gi√° c·ªßa kh√°ch h√†ng
        loadCustomerDiscountVouchers();
    }

    // Load danh s√°ch phi·∫øu gi·∫£m gi√° c·ªßa kh√°ch h√†ng
    function loadCustomerDiscountVouchers() {
        $.get('/Admin/ClientBanHangTaiQuay/danh-sach-phieu-giam-gia-khach-hang', { customerId: selectedCustomer.id }, function(data) {
            if (data && data.length > 0) {
                renderVoucherList(data);
                $('#voucherList').show();
                $('#noVoucherMessage').hide();
            } else {
                $('#voucherList').hide();
                $('#noVoucherMessage').show();
            }
            $('#discountVoucherModal').modal('show');
        }).fail(function() {
            showError('L·ªói khi t·∫£i danh s√°ch phi·∫øu gi·∫£m gi√°!');
        });
    }

    // Render danh s√°ch phi·∫øu gi·∫£m gi√°
    function renderVoucherList(vouchers) {
        let html = '<div class="row">';
        vouchers.forEach(function(voucher, index) {
            let isExpired = new Date(voucher.ngayKetThuc) < new Date();
            let isActive = !isExpired && new Date(voucher.ngayBatDau) <= new Date();
            
            html += `
                <div class="col-md-6 mb-3">
                    <div class="card ${isExpired ? 'border-danger' : isActive ? 'border-success' : 'border-warning'} h-100">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h6 class="mb-0">${voucher.tenPhieu}</h6>
                            <span class="badge ${isExpired ? 'bg-danger' : isActive ? 'bg-success' : 'bg-warning'}">
                                ${isExpired ? 'H·∫øt h·∫°n' : isActive ? 'C√≥ hi·ªáu l·ª±c' : 'Ch∆∞a c√≥ hi·ªáu l·ª±c'}
                            </span>
                        </div>
                        <div class="card-body">
                            <div class="mb-2">
                                <strong>M√£:</strong> <code>${voucher.maCode}</code>
                            </div>
                            <div class="mb-2">
                                <strong>Gi·∫£m gi√°:</strong> ${voucher.giaTriGiam}% (t·ªëi ƒëa ${voucher.giaTriGiamToiDa.toLocaleString()} VND)
                            </div>
                            <div class="mb-2">
                                <strong>ƒê∆°n t·ªëi thi·ªÉu:</strong> ${voucher.donToiThieu.toLocaleString()} VND
                            </div>
                            <div class="mb-2">
                                <strong>Hi·ªáu l·ª±c:</strong> ${new Date(voucher.ngayBatDau).toLocaleDateString('vi-VN')} - ${new Date(voucher.ngayKetThuc).toLocaleDateString('vi-VN')}
                            </div>
                            ${voucher.moTa ? `<div class="mb-2"><strong>M√¥ t·∫£:</strong> ${voucher.moTa}</div>` : ''}
                        </div>
                        <div class="card-footer">
                            <button class="btn btn-primary btn-sm w-100" 
                                    onclick="selectVoucher('${voucher.maCode}', ${voucher.giaTriGiam}, ${voucher.giaTriGiamToiDa}, ${voucher.donToiThieu})"
                                    ${!isActive ? 'disabled' : ''}>
                                ${isActive ? 'Ch·ªçn phi·∫øu n√†y' : 'Kh√¥ng c√≥ hi·ªáu l·ª±c'}
                            </button>
                        </div>
                    </div>
                </div>
            `;
        });
        html += '</div>';
        $('#voucherList').html(html);
    }

    // Ch·ªçn phi·∫øu gi·∫£m gi√°
    function selectVoucher(code, giaTriGiam, giaTriGiamToiDa, donToiThieu) {
        let gh = gioHangs[currentGioHang];
        if (!gh || !gh.products) {
            showWarning('Kh√¥ng c√≥ gi·ªè h√†ng n√†o ƒë∆∞·ª£c ch·ªçn!');
            return;
        }
        
        let total = gh.products.reduce((sum, p) => sum + p.thanhTien, 0);
        
        // Ki·ªÉm tra ƒë∆°n t·ªëi thi·ªÉu
        if (total < donToiThieu) {
            showWarning(`ƒê∆°n h√†ng ph·∫£i c√≥ gi√° tr·ªã t·ªëi thi·ªÉu ${donToiThieu.toLocaleString()} VND ƒë·ªÉ s·ª≠ d·ª•ng phi·∫øu n√†y!`);
            return;
        }
        
        // T√≠nh to√°n gi·∫£m gi√°
        let discountAmount = (total * giaTriGiam / 100);
        if (discountAmount > giaTriGiamToiDa) {
            discountAmount = giaTriGiamToiDa;
        }
        
        // C·∫≠p nh·∫≠t giao di·ªán
        $('#discountCode').val(code);
        discountValue = discountAmount;
        
        // ƒê√≥ng modal
        $('#discountVoucherModal').modal('hide');
        
        // C·∫≠p nh·∫≠t th√¥ng tin thanh to√°n
        updatePaymentInfo();
        
        showSuccess(`ƒê√£ √°p d·ª•ng phi·∫øu gi·∫£m gi√° ${code}! Gi·∫£m ${discountAmount.toLocaleString()} VND`);
    }

            // X√≥a phi·∫øu gi·∫£m gi√°
    function clearDiscount() {
        $('#discountCode').val('');
        discountValue = 0;
        updatePaymentInfo();
    }

    // Thanh to√°n h√≥a ƒë∆°n
    function openPaymentModal() {
        let pay = $('#payAmount').text();
        $('#modalPayAmount').text(pay);
        $('#modalCustomerPaid').val(pay.replace(/\D/g, ''));
        // ƒê·∫∑t l·∫°i ph∆∞∆°ng th·ª©c thanh to√°n trong modal theo ngo√†i giao di·ªán
        let currentMethod = $('#selectedPaymentMethod').text().trim();
        $('#paymentMethod').val(
            currentMethod === "Ti·ªÅn m·∫∑t" ? "cash" :
            currentMethod === "Chuy·ªÉn kho·∫£n" ? "bank" :
            currentMethod === "Th·∫ª" ? "card" : "cash"
        );
        updateModalChangeAmount();
        $('#confirmPaymentModal').modal('show');
    }

    // L∆∞u t·∫•t c·∫£ gi·ªè h√†ng v√†o localStorage
    function saveGioHangsToStorage() {
        const gioHangData = {
            gioHangs: gioHangs.map(gh => ({ id: gh.id, ma: gh.ma })),
            currentGioHang: currentGioHang
        };
        localStorage.setItem('gioHangData', JSON.stringify(gioHangData));
    }

    // T·∫°o gi·ªè h√†ng m·ªõi
    function taoGioHang() {
        const dto = {
            idKhachHang: selectedCustomer ? selectedCustomer.id : null,
            nguoiTao: "Admin"
        };
        
        $.ajax({
            url: '/Admin/ClientBanHangTaiQuay/tao-gio-hang',
            method: 'POST',
            contentType: 'application/json',
            data: JSON.stringify(dto),
            success: function(res) {
                const gioHang = {
                    id: res.idGioHang,
                    ma: res.maGioHang,
                    products: []
                };
                gioHangs.push(gioHang);
                currentGioHang = gioHangs.length - 1;
                // L∆∞u t·∫•t c·∫£ gi·ªè h√†ng v√†o localStorage
                saveGioHangsToStorage();
                renderTabs();
                loadGioHang(); // Load d·ªØ li·ªáu t·ª´ server
            },
            error: function(err) {
                showError('T·∫°o gi·ªè h√†ng th·∫•t b·∫°i!');
            }
        });
    }

    // Render tabs gi·ªè h√†ng
    function renderTabs() {
        let html = '';
        gioHangs.forEach((gh, idx) => {
            html += `<li class="nav-item">
                <a class="nav-link ${idx === currentGioHang ? 'active' : ''}" href="#" onclick="switchGioHang(${idx})">Gi·ªè h√†ng ${idx+1}${gh.products.length > 0 ? '<span class=\'badge bg-danger ms-1\'>'+gh.products.length+'</span>' : ''}</a>
            </li>`;
        });
        $('#invoiceTabs').html(html);
    }

    // Chuy·ªÉn gi·ªè h√†ng
    function switchGioHang(idx) {
        currentGioHang = idx;
        saveGioHangsToStorage(); // L∆∞u tr·∫°ng th√°i hi·ªán t·∫°i
        renderTabs();
        loadGioHang(); // Load d·ªØ li·ªáu t·ª´ server thay v√¨ render tr·ª±c ti·∫øp
    }

    // Load th√¥ng tin gi·ªè h√†ng t·ª´ server
    function loadGioHang() {
        if (gioHangs.length === 0 || !gioHangs[currentGioHang]) return;
        
        const gioHang = gioHangs[currentGioHang];
        $.get(`/Admin/ClientBanHangTaiQuay/gio-hang/${gioHang.id}`, function(data) {
            gioHang.products = data.sanPhams || [];
            renderGioHang();
            updatePaymentInfo(); // C·∫≠p nh·∫≠t th√¥ng tin thanh to√°n
        }).fail(function() {
            showError('L·ªói khi t·∫£i th√¥ng tin gi·ªè h√†ng!');
        });
    }

    // Render danh s√°ch s·∫£n ph·∫©m trong gi·ªè h√†ng
    function renderGioHang() {
        let gh = gioHangs[currentGioHang];
        if (!gh || gh.products.length === 0) {
            $('#invoiceContent').html(`
                <div class="text-center my-5">
                    <img src="https://cdn-icons-png.flaticon.com/512/1170/1170576.png" width="100" />
                    <p class="mt-3">Kh√¥ng c√≥ s·∫£n ph·∫©m n√†o trong gi·ªè</p>
                </div>
            `);
            return;
        }
        let rows = gh.products.map((p, i) => `
            <tr>
                <td>${i+1}</td>
                <td><img src="${p.anh}" width="60"/></td>
                <td>${p.ten}<br><small>K√≠ch c·ª°: ${p.kichCo} | M√†u s·∫Øc: ${p.mauSac}</small></td>
                <td>
                    ${p.giaGoc && p.giaGoc > p.giaBan ? `<span style="color:#888;text-decoration:line-through;font-size:0.95em;">${p.giaGoc.toLocaleString()} VND</span><br>` : ''}
                    <span style="font-weight:bold; color:#d32f2f;">${p.giaBan.toLocaleString()} VND</span>
                </td>
                <td>
                    <button class="btn btn-sm btn-light" onclick="changeQty('${p.id}',-1)">-</button>
                    <input type="number" class="form-control form-control-sm d-inline-block mx-2 text-center" style="width:80px" min="1" value="${p.soLuong}" onchange="changeQtyManual('${p.id}', this.value)" oninput="this.value=this.value.replace(/[^0-9]/g,'');" />
                    <button class="btn btn-sm btn-light" onclick="changeQty('${p.id}',1)">+</button>
                </td>
                <td>${p.thanhTien.toLocaleString()} VND</td>
                <td><button class="btn btn-danger btn-sm" onclick="removeProduct('${p.id}')">üóë</button></td>
            </tr>
        `).join('');
        let total = gh.products.reduce((sum, p) => sum + p.thanhTien, 0);
        $('#invoiceContent').html(`
            <table class="table table-bordered align-middle">
                <thead>
                    <tr>
                        <th>STT</th><th>·∫¢nh</th><th>S·∫£n ph·∫©m</th><th>Gi√° b√°n</th><th>S·ªë l∆∞·ª£ng</th><th>T·ªïng ti·ªÅn</th><th>Thao t√°c</th>
                    </tr>
                </thead>
                <tbody>${rows}</tbody>
            </table>
            <div class="d-flex justify-content-end">
                <h5 class="me-3">T·ªïng ti·ªÅn: <span class="text-danger">${total.toLocaleString()} VND</span></h5>
            </div>
        `);
        updatePaymentInfo();
    }

    // Thay ƒë·ªïi s·ªë l∆∞·ª£ng s·∫£n ph·∫©m
    function changeQty(productId, delta) {
        const gh = gioHangs[currentGioHang];
        const product = gh.products.find(p => p.id === productId);
        if (!product) return;

        const newQty = product.soLuong + delta;
        if (newQty < 1) {
            // X√≥a s·∫£n ph·∫©m n·∫øu s·ªë l∆∞·ª£ng = 0
            removeProduct(productId);
            return;
        }

        const dto = {
            idGioHang: gh.id,
            idSanPhamChiTiet: productId,
            soLuongMoi: newQty,
            nguoiCapNhat: "Admin"
        };

        $.ajax({
            url: '/Admin/ClientBanHangTaiQuay/cap-nhat-so-luong-gio-hang',
            method: 'POST',
            contentType: 'application/json',
            data: JSON.stringify(dto),
            success: function(res) {
                loadGioHang(); // Reload t·ª´ server
                loadProducts(); // c·∫≠p nh·∫≠t l·∫°i t·ªìn kho
            },
            error: function(xhr) {
                let msg = 'C·∫≠p nh·∫≠t s·ªë l∆∞·ª£ng th·∫•t b·∫°i!';
                if (xhr.responseJSON && xhr.responseJSON.message) msg = xhr.responseJSON.message;
                else if (xhr.responseText) {
                    try {
                        let obj = JSON.parse(xhr.responseText);
                        if (obj.message) msg = obj.message;
                        else msg = xhr.responseText;
                    } catch {
                        msg = xhr.responseText;
                    }
                }
                showError(msg);
            }
        });
    }

    // Nh·∫≠p s·ªë l∆∞·ª£ng th·ªß c√¥ng
    function changeQtyManual(productId, value) {
        const qty = parseInt(value, 10);
        if (isNaN(qty) || qty < 1) {
            removeProduct(productId);
            return;
        }

        const gh = gioHangs[currentGioHang];
        const dto = {
            idGioHang: gh.id,
            idSanPhamChiTiet: productId,
            soLuongMoi: qty,
            nguoiCapNhat: "Admin"
        };

        $.ajax({
            url: '/Admin/ClientBanHangTaiQuay/cap-nhat-so-luong-gio-hang',
            method: 'POST',
            contentType: 'application/json',
            data: JSON.stringify(dto),
            success: function(res) {
                loadGioHang(); // Reload t·ª´ server
                loadProducts(); // c·∫≠p nh·∫≠t l·∫°i t·ªìn kho
            },
            error: function(xhr) {
                let msg = 'C·∫≠p nh·∫≠t s·ªë l∆∞·ª£ng th·∫•t b·∫°i!';
                if (xhr.responseJSON && xhr.responseJSON.message) msg = xhr.responseJSON.message;
                else if (xhr.responseText) {
                    try {
                        let obj = JSON.parse(xhr.responseText);
                        if (obj.message) msg = obj.message;
                        else msg = xhr.responseText;
                    } catch {
                        msg = xhr.responseText;
                    }
                }
                showError(msg);
            }
        });
    }

    // X√≥a s·∫£n ph·∫©m kh·ªèi gi·ªè h√†ng
    function removeProduct(productId) {
        const gh = gioHangs[currentGioHang];
        const dto = {
            idGioHang: gh.id,
            idSanPhamChiTiet: productId,
            nguoiCapNhat: "Admin"
        };

        $.ajax({
            url: '/Admin/ClientBanHangTaiQuay/xoa-khoi-gio-hang',
            method: 'POST',
            contentType: 'application/json',
            data: JSON.stringify(dto),
            success: function(res) {
                loadGioHang(); // Reload t·ª´ server
                renderTabs();
                loadProducts(); // c·∫≠p nh·∫≠t l·∫°i t·ªìn kho
                
                // Hi·ªÉn th·ªã th√¥ng b√°o th√†nh c√¥ng
                if (res && res.message) {
                    showSuccess(res.message);
                }
            },
            error: function(xhr) {
                let msg = 'X√≥a s·∫£n ph·∫©m th·∫•t b·∫°i!';
                if (xhr.responseJSON && xhr.responseJSON.message) msg = xhr.responseJSON.message;
                else if (xhr.responseText) {
                    try {
                        let obj = JSON.parse(xhr.responseText);
                        if (obj.message) msg = obj.message;
                        else msg = xhr.responseText;
                    } catch {
                        msg = xhr.responseText;
                    }
                }
                showError(msg);
            }
        });
    }

    // Render modal ch·ªçn s·∫£n ph·∫©m
    function renderProductModal() {
        // L·ªçc s·∫£n ph·∫©m c√≥ s·ªë l∆∞·ª£ng > 0
        let availableProducts = products.filter(p => p.stock > 0);
        
        if (availableProducts.length === 0) {
            $('#productList').html(`
                <div class="text-center py-4">
                    <i class="bi bi-exclamation-triangle" style="font-size: 3rem; color: #ffc107;"></i>
                    <p class="mt-2 text-muted">Kh√¥ng c√≥ s·∫£n ph·∫©m n√†o trong kho</p>
                </div>
            `);
            return;
        }
        
        let html = `<table class="table table-hover">
            <thead>
                <tr>
                    <th>·∫¢nh</th><th>T√™n s·∫£n ph·∫©m</th><th>Gi√° b√°n</th><th>K√≠ch c·ª°</th><th>M√†u s·∫Øc</th><th>T·ªìn kho</th><th>H√†nh ƒë·ªông</th>
                </tr>
            </thead>
            <tbody>
                ${availableProducts.map(p => `
                    <tr>
                        <td><img src="${p.img}" width="60"/></td>
                        <td>${p.name}</td>
                        <td>
    ${
        (p.originalPrice && p.originalPrice > p.price)
        ? `<span style="display:inline-flex;align-items:center;gap:8px;">
      <span style="color:#888;text-decoration:line-through;font-size:0.95em;">${p.originalPrice.toLocaleString()} VND</span>
      <span style="color:#d32f2f;font-weight:bold;font-size:1em;">${p.price.toLocaleString()} VND</span>
   </span>`
        : `<span style="font-weight:bold;">${p.price.toLocaleString()} VND</span>`
    }
</td>
                        <td>${p.size}</td>
                        <td>${p.color}</td>
                        <td><span class="badge ${p.stock > 10 ? 'bg-success' : p.stock > 5 ? 'bg-warning' : 'bg-danger'}">${p.stock}</span></td>
                        <td><button class="btn btn-success btn-sm" onclick="addProductToGioHang('${p.id}')" ${p.stock <= 0 ? 'disabled' : ''}>Ch·ªçn</button></td>
                    </tr>
                `).join('')}
            </tbody>
        </table>`;
        $('#productList').html(html);
    }

    // Th√™m s·∫£n ph·∫©m v√†o gi·ªè h√†ng
    function addProductToGioHang(productId) {
        if (gioHangs.length === 0) {
            showWarning('Vui l√≤ng t·∫°o gi·ªè h√†ng tr∆∞·ªõc!');
            return;
        }

        const gh = gioHangs[currentGioHang];
        const dto = {
            idGioHang: gh.id,
            idSanPhamChiTiet: productId,
            soLuong: 1,
            nguoiCapNhat: "Admin"
        };

        $.ajax({
            url: '/Admin/ClientBanHangTaiQuay/them-vao-gio-hang',
            method: 'POST',
            contentType: 'application/json',
            data: JSON.stringify(dto),
            success: function(res) {
                $('#productModal').modal('hide');
                loadGioHang(); // Reload t·ª´ server
                renderTabs();
                loadProducts(); // c·∫≠p nh·∫≠t l·∫°i t·ªìn kho
                
                // Hi·ªÉn th·ªã th√¥ng b√°o th√†nh c√¥ng
                if (res && res.message) {
                    showSuccess(res.message);
                }
            },
            error: function(xhr) {
                let msg = 'Th√™m s·∫£n ph·∫©m th·∫•t b·∫°i!';
                if (xhr.responseJSON && xhr.responseJSON.message) msg = xhr.responseJSON.message;
                else if (xhr.responseText) {
                    try {
                        let obj = JSON.parse(xhr.responseText);
                        if (obj.message) msg = obj.message;
                        else msg = xhr.responseText;
                    } catch {
                        msg = xhr.responseText;
                    }
                }
                showError(msg);
            }
        });
    }

    function showCustomerModal() {
        renderCustomerList(customers);
        $('#customerModal').modal('show');
    }

    function renderCustomerList(list) {
        let html = list.map((c, i) => `
            <tr>
                <td>${i+1}</td>
                <td><img src="${c.img}" width="40" class="rounded-circle"/></td>
                <td>${c.name}</td>
                <td>${c.email}</td>
                <td>${c.phone}</td>
                <td>${c.point}</td>
                <td><button class="btn btn-outline-primary btn-sm" onclick="selectCustomer('${c.id}')">Ch·ªçn</button></td>
            </tr>
        `).join('');
        $('#customerList').html(html);
    }

    function selectCustomer(id) {
        selectedCustomer = customers.find(c => c.id == id);
        $('#customerModal').modal('hide');
        $('#customerName').text(selectedCustomer.name).removeClass('bg-secondary').addClass('bg-info');
        $('#customerDetails').show();
        $('#customerPhone').text(selectedCustomer.phone);
        $('#customerEmail').text(selectedCustomer.email);
        $('#customerPoint').text(selectedCustomer.point);
        
        // Hi·ªÉn th·ªã n√∫t h·ªßy ch·ªçn v√† c√°c n√∫t ƒë·ªãa ch·ªâ
        $('#btnClearCustomer').show();
        $('#btnShowAddress').show();
        $('#btnAddAddress').show();
        
        // Reset phi·∫øu gi·∫£m gi√° khi ch·ªçn kh√°ch h√†ng m·ªõi
        $('#discountCode').val('');
        discountValue = 0;
        
        // N·∫øu ƒëang b·∫≠t giao h√†ng th√¨ t·ª± ƒë·ªông load ƒë·ªãa ch·ªâ
        if (useShipping) {
            loadCustomerAddress();
        }
        
        updatePaymentInfo();
        
        // C·∫≠p nh·∫≠t th√¥ng tin kh√°ch h√†ng trong gi·ªè h√†ng hi·ªán t·∫°i n·∫øu c√≥
        if (gioHangs.length > 0 && gioHangs[currentGioHang]) {
            const gh = gioHangs[currentGioHang];
            // C√≥ th·ªÉ th√™m API ƒë·ªÉ c·∫≠p nh·∫≠t kh√°ch h√†ng cho gi·ªè h√†ng n·∫øu c·∫ßn
        }
    }

    // H·ªßy ch·ªçn kh√°ch h√†ng
    function clearCustomer() {
        selectedCustomer = null;
        
        // Reset th√¥ng tin hi·ªÉn th·ªã v·ªÅ kh√°ch l·∫ª
        $('#customerName').text('kh√°ch l·∫ª').removeClass('bg-info').addClass('bg-secondary');
        $('#customerDetails').hide();
        $('#customerPhone').text('');
        $('#customerEmail').text('');
        $('#customerPoint').text('0');
        
        // ·∫®n n√∫t h·ªßy ch·ªçn v√† c√°c n√∫t ƒë·ªãa ch·ªâ
        $('#btnClearCustomer').hide();
        $('#btnShowAddress').hide();
        $('#btnAddAddress').hide();
        
        // ·∫®n form ƒë·ªãa ch·ªâ giao h√†ng
        $('#shippingFormCard').hide();
        
        // Reset phi·∫øu gi·∫£m gi√°
        $('#discountCode').val('');
        discountValue = 0;
        
        // Reset th√¥ng tin giao h√†ng
        if (useShipping) {
            $('#shippingSwitch').prop('checked', false);
            useShipping = false;
            $('#shippingFee').val(0);
        }
        
        // Reset form ƒë·ªãa ch·ªâ
        $('#shipName').val('');
        $('#shipPhone').val('');
        $('#shipEmail').val('');
        $('#shipAddress').val('');
        $('#shipNote').val('');
        
        // C·∫≠p nh·∫≠t l·∫°i th√¥ng tin thanh to√°n
        updatePaymentInfo();
    }

    // Toggle giao h√†ng
    function toggleShipping() {
        useShipping = $('#shippingSwitch').is(':checked');
        if (useShipping) {
            $('#shippingFormCard').show();
            $('#btnShowAddress').show();
            $('#btnAddAddress').show();
            // T√≠nh ph√≠ v·∫≠n chuy·ªÉn ƒë·ªông thay v√¨ c·ªë ƒë·ªãnh
            calculateShippingFee();
            // N·∫øu ƒë√£ ch·ªçn kh√°ch h√†ng th√¨ t·ª± ƒë·ªông ƒëi·ªÅn ƒë·ªãa ch·ªâ
            if (selectedCustomer) {
                loadCustomerAddress();
            }
        } else {
            $('#shippingFormCard').hide();
            $('#btnShowAddress').hide();
            $('#btnAddAddress').hide();
            // Reset ph√≠ v·∫≠n chuy·ªÉn v·ªÅ 0
            shippingFee = 0;
            $('#shippingFee').val(0);
            // X√≥a hi·ªÉn th·ªã ph√≠ v·∫≠n chuy·ªÉn
            $('#shippingFeeDisplay').html('');
        }
        updatePaymentInfo();
    }

    // Load ƒë·ªãa ch·ªâ kh√°ch h√†ng
    function loadCustomerAddress() {
        if (!selectedCustomer) return;
        
        $.get('/Admin/ClientBanHangTaiQuay/dia-chi-khach-hang', { customerId: selectedCustomer.id }, function(data) {
            if (data && data.tenNguoiNhan) {
                // C√≥ ƒë·ªãa ch·ªâ, ƒëi·ªÅn th√¥ng tin
                $('#shipName').val(data.tenNguoiNhan);
                $('#shipPhone').val(data.sdtNguoiNhan || selectedCustomer.phone);
                $('#shipAddress').val(data.diaChiChiTiet || '');
                console.log('ƒê√£ ƒëi·ªÅn ƒë·ªãa ch·ªâ kh√°ch h√†ng:', data);
            } else {
                // Kh√¥ng c√≥ ƒë·ªãa ch·ªâ, ƒëi·ªÅn th√¥ng tin c∆° b·∫£n
                $('#shipName').val(selectedCustomer.name);
                $('#shipPhone').val(selectedCustomer.phone);
                $('#shipAddress').val('');
                console.log('Kh√¥ng c√≥ ƒë·ªãa ch·ªâ, ƒëi·ªÅn th√¥ng tin c∆° b·∫£n');
            }
        }).fail(function(xhr, status, error) {
            console.error('L·ªói khi l·∫•y ƒë·ªãa ch·ªâ kh√°ch h√†ng:', error);
            // Fallback: ƒëi·ªÅn th√¥ng tin c∆° b·∫£n
            $('#shipName').val(selectedCustomer.name);
            $('#shipPhone').val(selectedCustomer.phone);
            $('#shipAddress').val('');
        });
    }


    // Toggle s·ª≠ d·ª•ng ƒëi·ªÉm
    function togglePoint() {
        usePoint = $('#pointSwitch').is(':checked');
        updatePaymentInfo();
    }

    // C·∫≠p nh·∫≠t th√¥ng tin thanh to√°n (c√≥ t√≠nh l·∫°i ph√≠ v·∫≠n chuy·ªÉn)
    function updatePaymentInfo() {
        let gh = gioHangs[currentGioHang];
        let total = gh && gh.products ? gh.products.reduce((sum, p) => sum + p.thanhTien, 0) : 0;
        let discount = discountValue || 0;
        let point = (selectedCustomer && usePoint) ? selectedCustomer.point * 1000 : 0; // v√≠ d·ª• 1 ƒëi·ªÉm = 1000 VND
        let pay = total - discount - point + shippingFee;
        if (pay < 0) pay = 0;

        $('#goodsAmount').text(total.toLocaleString() + " VND");
        $('#discountAmount').text(discount.toLocaleString() + " VND");
        $('#payAmount').text(pay.toLocaleString() + " VND");
        $('#totalAmount').text(pay.toLocaleString() + " VND");
        
        // C·∫≠p nh·∫≠t ph√≠ v·∫≠n chuy·ªÉn trong input
        $('#shippingFee').val(shippingFee);
        
        // T·ª± ƒë·ªông t√≠nh l·∫°i ph√≠ v·∫≠n chuy·ªÉn khi t·ªïng ti·ªÅn thay ƒë·ªïi (n·∫øu ƒëang b·∫≠t giao h√†ng)
        if (useShipping && total > 0) {
            calculateShippingFee();
        }
    }

    // C·∫≠p nh·∫≠t th√¥ng tin thanh to√°n (kh√¥ng t√≠nh l·∫°i ph√≠ v·∫≠n chuy·ªÉn)
    function updatePaymentInfoWithoutRecalculation() {
        let gh = gioHangs[currentGioHang];
        let total = gh && gh.products ? gh.products.reduce((sum, p) => sum + p.thanhTien, 0) : 0;
        let discount = discountValue || 0;
        let point = (selectedCustomer && usePoint) ? selectedCustomer.point * 1000 : 0; // v√≠ d·ª• 1 ƒëi·ªÉm = 1000 VND
        let pay = total - discount - point + shippingFee;
        if (pay < 0) pay = 0;

        $('#goodsAmount').text(total.toLocaleString() + " VND");
        $('#discountAmount').text(discount.toLocaleString() + " VND");
        $('#payAmount').text(pay.toLocaleString() + " VND");
        $('#totalAmount').text(pay.toLocaleString() + " VND");
        
        // C·∫≠p nh·∫≠t ph√≠ v·∫≠n chuy·ªÉn trong input
        $('#shippingFee').val(shippingFee);
    }

    // G·ªçi l·∫°i khi render gi·ªè h√†ng
    let oldRenderGioHang = renderGioHang;
    renderGioHang = function() {
        oldRenderGioHang();
        updatePaymentInfo();
    }

    function updateModalChangeAmount() {
        let pay = parseInt($('#modalPayAmount').text().replace(/\D/g, '')) || 0;
        let customerPaid = parseInt($('#modalCustomerPaid').val()) || 0;
        let change = customerPaid - pay;
        let $change = $('#modalChangeAmount');
        $change.text(change.toLocaleString() + " ƒë");
        if (change < 0) {
            $change.removeClass('text-success').addClass('text-danger');
        } else {
            $change.removeClass('text-danger').addClass('text-success');
        }
    }

        function updatePaymentInfoFromModal() {
        // L·∫•y d·ªØ li·ªáu t·ª´ modal
        selectedPaymentCode = $('#paymentMethod').val();
        let customerPaid = parseInt($('#modalCustomerPaid').val()) || 0;
        let pay = parseInt($('#modalPayAmount').text().replace(/\D/g, '')) || 0;
        let change = customerPaid - pay;

        // C·∫≠p nh·∫≠t ra ngo√†i
        let $change = $('#changeAmount');
        $change.text(change.toLocaleString() + " VND");
        if (change < 0) {
            $change.removeClass('text-success').addClass('text-danger');
        } else {
            $change.removeClass('text-danger').addClass('text-success');
        }

        // Hi·ªÉn th·ªã t√™n ph∆∞∆°ng th·ª©c thanh to√°n ra ngo√†i
        $('#selectedPaymentMethod').text($('#paymentMethod option:selected').text());

        // ƒê√≥ng modal
        $('#confirmPaymentModal').modal('hide');
    }

    function payInvoice() {
        let gh = gioHangs[currentGioHang];
        if (!gh || !gh.products || gh.products.length === 0) return showError('Kh√¥ng c√≥ s·∫£n ph·∫©m trong gi·ªè h√†ng!');

        // L·∫•y l·∫°i c√°c th√¥ng tin ƒë√£ ch·ªçn t·ª´ ngo√†i giao di·ªán
        let paymentMethod = $('#selectedPaymentMethod').text() || "Ti·ªÅn m·∫∑t";
        let customerPaid = parseInt($('#modalCustomerPaid').val()) || 0;
        let pay = parseInt($('#payAmount').text().replace(/\D/g, '')) || 0;

        if (customerPaid < pay) {
            showError('Kh√°ch ƒë∆∞a ch∆∞a ƒë·ªß ti·ªÅn!');
            return;
        }

        // D·ªØ li·ªáu g·ª≠i ƒëi
        let dto = {
            idGioHang: gh.id,
            customerName: selectedCustomer ? selectedCustomer.name : $('#shipName').val(),
            customerPhone: selectedCustomer ? selectedCustomer.phone : $('#shipPhone').val(),
            customerEmail: selectedCustomer ? selectedCustomer.email : $('#shipEmail').val(),
            address: $('#shipAddress').val(),
            discountCode: $('#discountCode').val(),
            usePoint: usePoint,
            shipping: useShipping,
            paymentMethod: paymentMethod,
            customerPaid: customerPaid,
            shippingFee: shippingFee // Ph√≠ v·∫≠n chuy·ªÉn ƒë·ªông t·ª´ API
        };
        
        // N·∫øu ch·ªçn chuy·ªÉn kho·∫£n/th·∫ª -> chuy·ªÉn h∆∞·ªõng VNPay (POS)
        const isPosVnpay = paymentMethod.trim().toLowerCase() === 'chuy·ªÉn kho·∫£n' || paymentMethod.trim().toLowerCase() === 'th·∫ª';
        if (isPosVnpay) {
            const paymentInfo = {
                orderType: 'billpayment',
                amount: pay,
                orderDescription: `Thanh toan don POS ${dto.customerName}`,
                name: dto.customerName || 'Khach POS'
            };
            fetch('/Admin/ClientBanHangTaiQuay/vnpay/init', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(paymentInfo)
            }).then(r => r.json()).then(res => {
                if (res && res.success && res.paymentUrl) {
                    // L∆∞u t·∫°m order ƒë·ªÉ callback c√≥ th·ªÉ ƒë·ªçc (t·∫°o ƒë∆°n sau callback)
                    sessionStorage.setItem('POS_PendingDTO', JSON.stringify(dto));
                    window.location.href = res.paymentUrl;
                } else {
                    showError('Kh√¥ng t·∫°o ƒë∆∞·ª£c URL thanh to√°n VNPay.');
                }
            }).catch(() => showError('L·ªói khi kh·ªüi t·∫°o thanh to√°n VNPay.'));
            return;
        }

        $.ajax({
            url: '/Admin/ClientBanHangTaiQuay/chuyen-gio-hang-thanh-hoa-don',
            method: 'POST',
            contentType: 'application/json',
            data: JSON.stringify(dto),
            success: function(res) {
                showSuccess('Thanh to√°n th√†nh c√¥ng!');
                $('#confirmPaymentModal').modal('hide');
                
                // X√≥a gi·ªè h√†ng ƒë√£ thanh to√°n
                gioHangs.splice(currentGioHang, 1);
                if (gioHangs.length === 0) {
                    taoGioHang();
                } else {
                    currentGioHang = Math.max(0, currentGioHang - 1);
                }
                
                // C·∫≠p nh·∫≠t localStorage
                saveGioHangsToStorage();
                renderTabs();
                loadGioHang();
                clearDiscount();
            },
            error: function(err) {
                showError('Thanh to√°n th·∫•t b·∫°i!');
            }
        });
    }

    // Kh·ªüi t·∫°o t·ªânh (gi·ªØ nguy√™n n·∫øu mu·ªën d·ªØ li·ªáu m·∫´u)
    const provinces = ["H√† N·ªôi", "H·ªì Ch√≠ Minh"];
    const districts = { "H√† N·ªôi": ["Ba ƒê√¨nh", "C·∫ßu Gi·∫•y"], "H·ªì Ch√≠ Minh": ["Qu·∫≠n 1", "Qu·∫≠n 3"] };
    const wards = { "Ba ƒê√¨nh": ["Ph∆∞·ªùng 1", "Ph∆∞·ªùng 2"], "C·∫ßu Gi·∫•y": ["Ph∆∞·ªùng 3", "Ph∆∞·ªùng 4"], "Qu·∫≠n 1": ["Ph∆∞·ªùng 5"], "Qu·∫≠n 3": ["Ph∆∞·ªùng 6"] };
    $('#shipProvince').on('change', function() {
        let val = $(this).val();
        let opts = (districts[val] || []).map(d => `<option>${d}</option>`).join('');
        $('#shipDistrict').html('<option>Ch·ªçn Qu·∫≠n</option>' + opts);
        $('#shipWard').html('<option>Ch·ªçn Ph∆∞·ªùng x√£</option>');
    });
    $('#shipDistrict').on('change', function() {
        let val = $(this).val();
        let opts = (wards[val] || []).map(w => `<option>${w}</option>`).join('');
        $('#shipWard').html('<option>Ch·ªçn Ph∆∞·ªùng x√£</option>' + opts);
    });
    $('#shipProvince').html('<option>Ch·ªçn t·ªânh</option>' + provinces.map(p => `<option>${p}</option>`).join(''));

    // Load ph∆∞∆°ng th·ª©c thanh to√°n ƒë·ªông t·ª´ API
    function loadPaymentMethods() {
        $.get('/api/BanHangTaiQuay/danh-sach-phuong-thuc-thanh-toan', function(data) {
            let html = '';
            data.forEach(function(method) {
                html += `<option value="${method.maPhuongThuc}">${method.tenPhuongThuc}</option>`;
            });
            $('#paymentMethod').html(html);
        });
    }

    // Kh√¥i ph·ª•c t·∫•t c·∫£ gi·ªè h√†ng t·ª´ localStorage
    function restoreGioHangsFromStorage() {
        const savedData = localStorage.getItem('gioHangData');
        if (savedData) {
            try {
                const gioHangData = JSON.parse(savedData);
                if (gioHangData.gioHangs && gioHangData.gioHangs.length > 0) {
                    // Kh√¥i ph·ª•c t·ª´ng gi·ªè h√†ng
                    let loadPromises = gioHangData.gioHangs.map(gh => 
                        $.get(`/Admin/ClientBanHangTaiQuay/gio-hang/${gh.id}`)
                            .then(data => {
                                if (data && data.idGioHang) {
                                    return {
                                        id: data.idGioHang,
                                        ma: data.maGioHang,
                                        products: data.sanPhams || []
                                    };
                                }
                                return null;
                            })
                            .catch(() => null)
                    );
                    
                    Promise.all(loadPromises).then(results => {
                        // L·ªçc b·ªè c√°c gi·ªè h√†ng null (kh√¥ng t·ªìn t·∫°i)
                        gioHangs = results.filter(gh => gh !== null);
                        
                        if (gioHangs.length > 0) {
                            // Kh√¥i ph·ª•c currentGioHang, ƒë·∫£m b·∫£o kh√¥ng v∆∞·ª£t qu√° s·ªë l∆∞·ª£ng gi·ªè h√†ng
                            currentGioHang = Math.min(gioHangData.currentGioHang || 0, gioHangs.length - 1);
                            renderTabs();
                            loadGioHang();
                        } else {
                            // N·∫øu kh√¥ng c√≥ gi·ªè h√†ng n√†o h·ª£p l·ªá, t·∫°o m·ªõi
                            taoGioHang();
                        }
                    });
                    return true; // ƒê√£ kh√¥i ph·ª•c
                }
            } catch (e) {
                console.error('L·ªói khi kh√¥i ph·ª•c gi·ªè h√†ng t·ª´ localStorage:', e);
            }
        }
        return false; // Kh√¥ng kh√¥i ph·ª•c ƒë∆∞·ª£c
    }

    // Kh·ªüi t·∫°o gi·ªè h√†ng ƒë·∫ßu ti√™n v√† load d·ªØ li·ªáu ƒë·ªông
    $(document).ready(function() {
        // Th·ª≠ kh√¥i ph·ª•c gi·ªè h√†ng t·ª´ localStorage tr∆∞·ªõc
        if (!restoreGioHangsFromStorage()) {
            // N·∫øu kh√¥ng kh√¥i ph·ª•c ƒë∆∞·ª£c, t·∫°o gi·ªè h√†ng m·ªõi
            taoGioHang();
        }
        loadProducts();
        loadCustomers();
        loadPaymentMethods(); // Load ph∆∞∆°ng th·ª©c thanh to√°n ƒë·ªông t·ª´ API

        $('#btnAddInvoice').click(function() {
            if (gioHangs.length < maxGioHangs) {
                taoGioHang();
            } else {
                showWarning('Ch·ªâ ƒë∆∞·ª£c t·ªëi ƒëa 5 gi·ªè h√†ng ch·ªù!');
            }
        });

        // Khi m·ªü modal ch·ªçn s·∫£n ph·∫©m, lu√¥n reload s·∫£n ph·∫©m m·ªõi nh·∫•t
        $('#btnAddProduct').click(function() {
            loadProducts(function() {
                renderProductModal();
                $('#productModal').modal('show');
            });
        });
        
                    // C·∫≠p nh·∫≠t th√¥ng tin thanh to√°n ban ƒë·∫ßu
        setTimeout(function() {
            if (gioHangs.length > 0) {
                updatePaymentInfo();
            }
        }, 1000);
    });

    function loadPaymentMethods() {
        $.get('/Admin/ClientBanHangTaiQuay/danh-sach-phuong-thuc-thanh-toan', function(data) {
            let html = '';
            data.forEach(function(method) {
                html += `<option value="${method.maPhuongThuc}">${method.tenPhuongThuc}</option>`;
            });
            $('#paymentMethod').html(html);
            // Set m·∫∑c ƒë·ªãnh t·ª´ DB (ph∆∞∆°ng th·ª©c ƒë·∫ßu ti√™n)
            if (data.length > 0) {
                selectedPaymentCode = data[0].maPhuongThuc;
                $('#selectedPaymentMethod').text(data[0].tenPhuongThuc);
                $('#paymentMethod').val(selectedPaymentCode);
            }
        });
    }

    // M·ªü modal ch·ªçn ƒë·ªãa ch·ªâ
    function focusAddressForm() {
        if (!selectedCustomer) {
            showWarning('Vui l√≤ng ch·ªçn kh√°ch h√†ng tr∆∞·ªõc!');
            return;
        }
        
        // B·∫≠t giao h√†ng n·∫øu ch∆∞a b·∫≠t
        if (!useShipping) {
            $('#shippingSwitch').prop('checked', true);
            toggleShipping();
        }
        
        // M·ªü modal ch·ªçn ƒë·ªãa ch·ªâ
        openSelectAddressModal();
    }

    // M·ªü modal th√™m ƒë·ªãa ch·ªâ m·ªõi
    function openAddAddressModal() {
        if (!selectedCustomer) {
            showWarning('Vui l√≤ng ch·ªçn kh√°ch h√†ng tr∆∞·ªõc!');
            return;
        }
        
        // ƒê√≥ng modal ch·ªçn ƒë·ªãa ch·ªâ n·∫øu ƒëang m·ªü
        $('#selectAddressModal').modal('hide');
        
        // ƒêi·ªÅn th√¥ng tin m·∫∑c ƒë·ªãnh t·ª´ kh√°ch h√†ng
        $('#newAddressName').val(selectedCustomer.name);
        $('#newAddressPhone').val(selectedCustomer.phone);
        $('#newAddressDetail').val('');
        $('#newAddressDefault').prop('checked', false);
        
        // M·ªü modal th√™m ƒë·ªãa ch·ªâ sau khi ƒë√≥ng modal ch·ªçn ƒë·ªãa ch·ªâ
        setTimeout(function() {
            $('#addAddressModal').modal('show');
        }, 300);
    }

    // M·ªü modal ch·ªçn ƒë·ªãa ch·ªâ
    function openSelectAddressModal() {
        if (!selectedCustomer) {
            showWarning('Vui l√≤ng ch·ªçn kh√°ch h√†ng tr∆∞·ªõc!');
            return;
        }
        
        // Load danh s√°ch ƒë·ªãa ch·ªâ
        loadCustomerAddresses();
        
        $('#selectAddressModal').modal('show');
    }

    // Load danh s√°ch ƒë·ªãa ch·ªâ c·ªßa kh√°ch h√†ng
    function loadCustomerAddresses() {
        if (!selectedCustomer) return;
        
        $.get('/Admin/ClientBanHangTaiQuay/danh-sach-dia-chi-khach-hang', { customerId: selectedCustomer.id }, function(data) {
            if (data && Array.isArray(data) && data.length > 0) {
                renderAddressList(data);
                $('#addressList').show();
                $('#noAddressMessage').hide();
            } else {
                $('#addressList').hide();
                $('#noAddressMessage').show();
            }
        }).fail(function(xhr, status, error) {
            console.error('L·ªói khi l·∫•y danh s√°ch ƒë·ªãa ch·ªâ:', error);
            $('#addressList').hide();
            $('#noAddressMessage').show();
        });
    }

    // Render danh s√°ch ƒë·ªãa ch·ªâ
    function renderAddressList(addresses) {
        let html = '';
        addresses.forEach((address, index) => {
            const isDefault = address.laMacDinh ? '<span class="badge bg-primary ms-2">M·∫∑c ƒë·ªãnh</span>' : '';
            const isSelected = (address.diaChiChiTiet === $('#shipAddress').val()) ? 'border-primary' : 'border-light';
            
            // Escape c√°c k√Ω t·ª± ƒë·∫∑c bi·ªát ƒë·ªÉ tr√°nh l·ªói JavaScript
            const safeTenNguoiNhan = (address.tenNguoiNhan || '').replace(/'/g, "\\'").replace(/"/g, '\\"');
            const safeSdtNguoiNhan = (address.sdtNguoiNhan || '').replace(/'/g, "\\'").replace(/"/g, '\\"');
            const safeDiaChiChiTiet = (address.diaChiChiTiet || '').replace(/'/g, "\\'").replace(/"/g, '\\"');
            
            html += `
                <div class="card mb-2 address-item ${isSelected}" style="cursor: pointer;" onclick="selectAddress('${address.id}', '${safeTenNguoiNhan}', '${safeSdtNguoiNhan}', '${safeDiaChiChiTiet}')">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-start">
                            <div class="flex-grow-1">
                                <h6 class="card-title mb-1">
                                    ${address.tenNguoiNhan || 'N/A'} ${isDefault}
                                </h6>
                                <p class="card-text mb-1">
                                    <i class="bi bi-telephone"></i> ${address.sdtNguoiNhan || 'N/A'}
                                </p>
                                <p class="card-text text-muted mb-0">
                                    <i class="bi bi-geo-alt"></i> ${address.diaChiChiTiet || 'N/A'}
                                </p>
                            </div>
                            <div class="ms-2">
                                <i class="bi bi-check-circle-fill text-primary" style="display: ${isSelected.includes('border-primary') ? 'block' : 'none'};"></i>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        });
        
        $('#addressList').html(html);
    }

    // Ch·ªçn ƒë·ªãa ch·ªâ
    function selectAddress(addressId, tenNguoiNhan, sdtNguoiNhan, diaChiChiTiet) {
        // ƒêi·ªÅn th√¥ng tin v√†o form giao h√†ng
        $('#shipName').val(tenNguoiNhan);
        $('#shipPhone').val(sdtNguoiNhan);
        $('#shipAddress').val(diaChiChiTiet);
        
        // ƒê√≥ng modal
        $('#selectAddressModal').modal('hide');
        
        // Hi·ªÉn th·ªã th√¥ng b√°o
        showSuccess('ƒê√£ ch·ªçn ƒë·ªãa ch·ªâ giao h√†ng!');
    }



    // Th√™m CSS cho modal ch·ªçn ƒë·ªãa ch·ªâ
    $(document).ready(function() {
        // Th√™m CSS cho address-item
        $('<style>')
            .prop('type', 'text/css')
            .html(`
                .address-item {
                    transition: all 0.3s ease;
                    border: 2px solid #e9ecef;
                }
                .address-item:hover {
                    border-color: #007bff;
                    box-shadow: 0 2px 8px rgba(0,123,255,0.15);
                    transform: translateY(-1px);
                }
                .address-item.border-primary {
                    border-color: #007bff;
                    background-color: #f8f9ff;
                }
                .address-item .card-body {
                    padding: 1rem;
                }
                .address-item .card-title {
                    font-size: 1rem;
                    font-weight: 600;
                    color: #333;
                }
                .address-item .card-text {
                    font-size: 0.9rem;
                    line-height: 1.4;
                }
                .address-item .bi {
                    margin-right: 0.5rem;
                }
            `)
            .appendTo('head');
    });



    // T·∫°o ƒë·ªãa ch·ªâ m·ªõi
    function createNewAddress() {
        if (!selectedCustomer) {
            showWarning('Vui l√≤ng ch·ªçn kh√°ch h√†ng tr∆∞·ªõc!');
            return;
        }

        const addressData = {
            idKhachHang: selectedCustomer.id,
            diaChiChiTiet: $('#newAddressDetail').val().trim(),
            tenNguoiNhan: $('#newAddressName').val().trim(),
            sdtNguoiNhan: $('#newAddressPhone').val().trim(),
            laMacDinh: $('#newAddressDefault').is(':checked')
        };

        // Validation
        if (!addressData.diaChiChiTiet) {
            showWarning('Vui l√≤ng nh·∫≠p ƒë·ªãa ch·ªâ chi ti·∫øt!');
            return;
        }

        if (!addressData.tenNguoiNhan) {
            showWarning('Vui l√≤ng nh·∫≠p t√™n ng∆∞·ªùi nh·∫≠n!');
            return;
        }

        // G·ªçi API t·∫°o ƒë·ªãa ch·ªâ
        $.ajax({
            url: '/Admin/ClientBanHangTaiQuay/tao-dia-chi',
            method: 'POST',
            contentType: 'application/json',
            data: JSON.stringify(addressData),
            success: function(response) {
                showSuccess('T·∫°o ƒë·ªãa ch·ªâ th√†nh c√¥ng!');
                $('#addAddressModal').modal('hide');
                
                // N·∫øu ƒë√¢y l√† ƒë·ªãa ch·ªâ m·∫∑c ƒë·ªãnh, t·ª± ƒë·ªông ƒëi·ªÅn v√†o form giao h√†ng
                if (addressData.laMacDinh && useShipping) {
                    $('#shipName').val(addressData.tenNguoiNhan);
                    $('#shipPhone').val(addressData.sdtNguoiNhan);
                    $('#shipAddress').val(addressData.diaChiChiTiet);
                }
                
                // M·ªü l·∫°i modal ch·ªçn ƒë·ªãa ch·ªâ v√† refresh danh s√°ch
                setTimeout(function() {
                    $('#selectAddressModal').modal('show');
                    loadCustomerAddresses();
                }, 300);
            },
            error: function(xhr) {
                let errorMessage = 'L·ªói khi t·∫°o ƒë·ªãa ch·ªâ!';
                if (xhr.responseText) {
                    try {
                        const error = JSON.parse(xhr.responseText);
                        errorMessage = error.message || errorMessage;
                    } catch (e) {
                        errorMessage = xhr.responseText;
                    }
                }
                showError(errorMessage);
            }
        });
    }

    // L∆∞u ƒë·ªãa ch·ªâ hi·ªán t·∫°i cho kh√°ch h√†ng
    function saveAddressToCustomer() {
        if (!selectedCustomer) {
            showWarning('Vui l√≤ng ch·ªçn kh√°ch h√†ng tr∆∞·ªõc!');
            return;
        }

        const shipName = $('#shipName').val().trim();
        const shipPhone = $('#shipPhone').val().trim();
        const shipAddress = $('#shipAddress').val().trim();

        if (!shipAddress) {
            showWarning('Vui l√≤ng nh·∫≠p ƒë·ªãa ch·ªâ chi ti·∫øt!');
            return;
        }

        if (!shipName) {
            showWarning('Vui l√≤ng nh·∫≠p t√™n ng∆∞·ªùi nh·∫≠n!');
            return;
        }

        const addressData = {
            idKhachHang: selectedCustomer.id,
            diaChiChiTiet: shipAddress,
            tenNguoiNhan: shipName,
            sdtNguoiNhan: shipPhone,
            laMacDinh: true // ƒê·∫∑t l√†m ƒë·ªãa ch·ªâ m·∫∑c ƒë·ªãnh
        };

        // G·ªçi API t·∫°o ƒë·ªãa ch·ªâ
        $.ajax({
            url: '/Admin/ClientBanHangTaiQuay/tao-dia-chi',
            method: 'POST',
            contentType: 'application/json',
            data: JSON.stringify(addressData),
            success: function(response) {
                showSuccess('L∆∞u ƒë·ªãa ch·ªâ th√†nh c√¥ng!');
            },
            error: function(xhr) {
                let errorMessage = 'L·ªói khi l∆∞u ƒë·ªãa ch·ªâ!';
                if (xhr.responseText) {
                    try {
                        const error = JSON.parse(xhr.responseText);
                        errorMessage = error.message || errorMessage;
                    } catch (e) {
                        errorMessage = xhr.responseText;
                    }
                }
                showError(errorMessage);
            }
        });
    }

    // ===== ADDRESS HANDLING FUNCTIONS (Similar to Checkout) =====
    
    // M·ªü modal ch·ªçn ƒë·ªãa ch·ªâ c√≥ s·∫µn
    async function openAddressModal() {
        if (!selectedCustomer) {
            showWarning('Vui l√≤ng ch·ªçn kh√°ch h√†ng tr∆∞·ªõc!');
            return;
        }

        try {
            const response = await fetch(`/Admin/ClientBanHangTaiQuay/dia-chi-khach-hang/${selectedCustomer.id}`);
            const addresses = await response.json();
            
            let addressHtml = '';
            if (addresses && addresses.length > 0) {
                addresses.forEach(addr => {
                    const isDefault = addr.laMacDinh ? '<span class="badge bg-primary">M·∫∑c ƒë·ªãnh</span>' : '';
                    addressHtml += `
                        <div class="address-card card mb-3" onclick="selectAddress('${addr.idDiaChi}', '${addr.tenNguoiNhan || ''}', '${addr.sdtNguoiNhan || ''}', '${addr.diaChiChiTiet || ''}')">
                            <div class="card-body">
                                <div class="d-flex justify-content-between align-items-start">
                                    <div>
                                        <h6 class="card-title mb-1">${addr.tenNguoiNhan || 'N/A'}</h6>
                                        <p class="card-text mb-1"><i class="fa fa-phone"></i> ${addr.sdtNguoiNhan || 'N/A'}</p>
                                        <p class="card-text mb-0"><i class="fa fa-map-marker"></i> ${addr.diaChiChiTiet || ''}</p>
                                    </div>
                                    <div>
                                        ${isDefault}
                                        <button class="btn btn-danger btn-sm ms-2" onclick="event.stopPropagation(); deleteAddress('${addr.idDiaChi}')" title="X√≥a ƒë·ªãa ch·ªâ">
                                            <i class="fa fa-trash"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                });
            } else {
                addressHtml = '<div class="text-center text-muted py-4"><i class="fa fa-map-marker fa-3x mb-3"></i><br>Kh√°ch h√†ng ch∆∞a c√≥ ƒë·ªãa ch·ªâ n√†o</div>';
            }
            
            $('#addressList').html(addressHtml);
            $('#selectAddressModal').modal('show');
        } catch (error) {
            console.error('Error loading addresses:', error);
            showError('L·ªói khi t·∫£i danh s√°ch ƒë·ªãa ch·ªâ!');
        }
    }

    // Ch·ªçn ƒë·ªãa ch·ªâ t·ª´ modal
    async function selectAddress(addressId, tenNguoiNhan, sdtNguoiNhan, diaChiChiTiet) {
        // ƒêi·ªÅn th√¥ng tin v√†o form giao h√†ng
        if (tenNguoiNhan && tenNguoiNhan !== 'N/A') {
            $('#shipName').val(tenNguoiNhan);
        }
        if (sdtNguoiNhan && sdtNguoiNhan !== 'N/A') {
            $('#shipPhone').val(sdtNguoiNhan);
        }
        
        // S·ª≠ d·ª•ng logic parse v√† populate dropdown nh∆∞ checkout
        if (diaChiChiTiet) {
            await populateAddressFromString(diaChiChiTiet);
        }

        // L∆∞u ID ƒë·ªãa ch·ªâ ƒë√£ ch·ªçn
        $('#selectedAddressId').val(addressId);
        
        // ƒê√≥ng modal
        $('#selectAddressModal').modal('hide');
        
        // T√≠nh l·∫°i ph√≠ v·∫≠n chuy·ªÉn n·∫øu c√≥ ƒë·ªãa ch·ªâ
        if (diaChiChiTiet && typeof calculateShippingFee === 'function') {
            calculateShippingFee();
        }
        
        showSuccess('ƒê√£ ch·ªçn ƒë·ªãa ch·ªâ th√†nh c√¥ng!');
    }

    // X√≥a form ƒë·ªãa ch·ªâ
    function clearAddressForm() {
        $('#shipName').val('');
        $('#shipPhone').val('');
        $('#shipEmail').val('');
        $('#shipAddress').val('');
        $('#selectedAddressId').val('');
        
        // Reset dropdown ƒë·ªãa ch·ªâ
        if (document.getElementById('shipTinh')) {
            document.getElementById('shipTinh').value = '0';
            document.getElementById('shipQuan').innerHTML = '<option value="0">Qu·∫≠n Huy·ªán</option>';
            document.getElementById('shipPhuong').innerHTML = '<option value="0">Ph∆∞·ªùng X√£</option>';
            document.getElementById('shipDiaChiChiTiet').value = '';
        }
        
        // Reset ph√≠ v·∫≠n chuy·ªÉn
        if (typeof updateShippingDisplay === 'function') {
            updateShippingDisplay(0, 0, 0);
        }
        
        showInfo('ƒê√£ x√≥a th√¥ng tin ƒë·ªãa ch·ªâ');
    }

    // M·ªü modal l∆∞u ƒë·ªãa ch·ªâ m·ªõi
    function openSaveAddressModal() {
        if (!selectedCustomer) {
            showWarning('Vui l√≤ng ch·ªçn kh√°ch h√†ng tr∆∞·ªõc!');
            return;
        }

        // L·∫•y th√¥ng tin t·ª´ form hi·ªán t·∫°i
        const shipName = $('#shipName').val();
        const shipPhone = $('#shipPhone').val();
        const shipAddress = $('#shipAddress').val();
        
        // ƒêi·ªÅn th√¥ng tin v√†o modal
        $('#saveAddressName').val(shipName);
        $('#saveAddressPhone').val(shipPhone);
        $('#saveAddressDetail').val(shipAddress);
        
        // Hi·ªÉn th·ªã modal
        $('#saveAddressModal').modal('show');
    }

    // L∆∞u ƒë·ªãa ch·ªâ m·ªõi t·ª´ modal
    function saveNewAddress() {
        if (!selectedCustomer) {
            showWarning('Vui l√≤ng ch·ªçn kh√°ch h√†ng tr∆∞·ªõc!');
            return;
        }

        const addressData = {
            idKhachHang: selectedCustomer.id,
            tenNguoiNhan: $('#saveAddressName').val().trim(),
            sdtNguoiNhan: $('#saveAddressPhone').val().trim(),
            diaChiChiTiet: $('#saveAddressDetail').val().trim(),
            laMacDinh: $('#saveAddressDefault').is(':checked')
        };

        // Validation
        if (!addressData.diaChiChiTiet) {
            showWarning('Vui l√≤ng nh·∫≠p ƒë·ªãa ch·ªâ chi ti·∫øt!');
            $('#saveAddressDetail').focus();
            return;
        }

        if (!addressData.tenNguoiNhan) {
            showWarning('Vui l√≤ng nh·∫≠p t√™n ng∆∞·ªùi nh·∫≠n!');
            $('#saveAddressName').focus();
            return;
        }

        // Validate s·ªë ƒëi·ªán tho·∫°i n·∫øu c√≥ nh·∫≠p
        if (addressData.sdtNguoiNhan && !validateVietnamesePhoneNumber(addressData.sdtNguoiNhan)) {
            showWarning('S·ªë ƒëi·ªán tho·∫°i kh√¥ng h·ª£p l·ªá. Vui l√≤ng nh·∫≠p s·ªë ƒëi·ªán tho·∫°i Vi·ªát Nam h·ª£p l·ªá.');
            $('#saveAddressPhone').focus();
            return;
        }

        // G·ªçi API t·∫°o ƒë·ªãa ch·ªâ
        $.ajax({
            url: '/Admin/ClientBanHangTaiQuay/tao-dia-chi',
            method: 'POST',
            contentType: 'application/json',
            data: JSON.stringify(addressData),
            success: function(response) {
                showSuccess('L∆∞u ƒë·ªãa ch·ªâ th√†nh c√¥ng!');
                $('#saveAddressModal').modal('hide');
                
                // C·∫≠p nh·∫≠t form giao h√†ng n·∫øu l√† ƒë·ªãa ch·ªâ m·∫∑c ƒë·ªãnh
                if (addressData.laMacDinh) {
                    $('#shipName').val(addressData.tenNguoiNhan);
                    $('#shipPhone').val(addressData.sdtNguoiNhan);
                    $('#shipAddress').val(addressData.diaChiChiTiet);
                    calculateShippingFee();
                }
            },
            error: function(xhr) {
                let errorMessage = 'L·ªói khi l∆∞u ƒë·ªãa ch·ªâ!';
                if (xhr.responseText) {
                    try {
                        const error = JSON.parse(xhr.responseText);
                        errorMessage = error.message || errorMessage;
                    } catch (e) {
                        errorMessage = xhr.responseText;
                    }
                }
                showError(errorMessage);
            }
        });
    }

    // X√≥a ƒë·ªãa ch·ªâ
    async function deleteAddress(addressId) {
        if (!confirm('B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a ƒë·ªãa ch·ªâ n√†y?')) {
            return;
        }

        try {
            const response = await fetch(`/Admin/ClientBanHangTaiQuay/xoa-dia-chi/${addressId}`, {
                method: 'DELETE'
            });
            
            if (response.ok) {
                showSuccess('X√≥a ƒë·ªãa ch·ªâ th√†nh c√¥ng!');
                // Refresh danh s√°ch ƒë·ªãa ch·ªâ
                openAddressModal();
            } else {
                showError('L·ªói khi x√≥a ƒë·ªãa ch·ªâ!');
            }
        } catch (error) {
            console.error('Error deleting address:', error);
            showError('L·ªói khi x√≥a ƒë·ªãa ch·ªâ!');
        }
    }

    // H√†m validate s·ªë ƒëi·ªán tho·∫°i Vi·ªát Nam
    function validateVietnamesePhoneNumber(phoneNumber) {
        if (!phoneNumber || phoneNumber.trim() === '') {
            return true; // Cho ph√©p ƒë·ªÉ tr·ªëng
        }

        const cleaned = phoneNumber.replace(/[^\d+]/g, '');
        
        // Format s·ªë ƒëi·ªán tho·∫°i
        let formatted = cleaned;
        if (cleaned.startsWith('+84')) {
            formatted = '0' + cleaned.substring(3);
        } else if (cleaned.startsWith('84')) {
            formatted = '0' + cleaned.substring(2);
        }
        
        // Regex pattern cho s·ªë ƒëi·ªán tho·∫°i Vi·ªát Nam
        const pattern = /^(0)(3[2-9]|5[689]|7[06-9]|8[1-689]|9[0-46-9])[0-9]{7}$/;
        
        return pattern.test(formatted);
    }

    // Hi·ªÉn th·ªã th√¥ng tin ph√≠ v·∫≠n chuy·ªÉn chi ti·∫øt
    function updateShippingFeeDisplay(shippingResponse) {
        const originalFee = shippingResponse.originalFee || 0;
        const finalFee = shippingResponse.finalFee || 0;
        const discountAmount = shippingResponse.discountAmount || 0;
        const discountMessage = shippingResponse.discountMessage || '';
        
        // T·∫°o HTML hi·ªÉn th·ªã ph√≠ v·∫≠n chuy·ªÉn
        let feeDisplayHtml = '';
        
        if (discountAmount > 0) {
            // C√≥ gi·∫£m gi√°
            feeDisplayHtml = `
                <div class="shipping-fee-details">
                    <div class="original-fee text-muted">
                        <small>Ph√≠ g·ªëc: <span style="text-decoration: line-through;">${originalFee.toLocaleString()} VNƒê</span></small>
                    </div>
                    <div class="final-fee text-success fw-bold">
                        Ph√≠ v·∫≠n chuy·ªÉn: ${finalFee.toLocaleString()} VNƒê
                    </div>
                    <div class="discount-info text-success">
                        <small><i class="bi bi-tag"></i> ${discountMessage}</small>
                    </div>
                </div>
            `;
        } else {
            // Kh√¥ng c√≥ gi·∫£m gi√°
            feeDisplayHtml = `
                <div class="shipping-fee-details">
                    <div class="final-fee fw-bold">
                        Ph√≠ v·∫≠n chuy·ªÉn: ${finalFee.toLocaleString()} VNƒê
                    </div>
                </div>
            `;
        }
        
        // T√¨m v√† c·∫≠p nh·∫≠t ph·∫ßn hi·ªÉn th·ªã ph√≠ v·∫≠n chuy·ªÉn
        let feeDisplayElement = $('#shippingFeeDisplay');
        if (feeDisplayElement.length === 0) {
            // T·∫°o element m·ªõi n·∫øu ch∆∞a c√≥
            $('#shippingFee').after('<div id="shippingFeeDisplay" class="mt-2"></div>');
            feeDisplayElement = $('#shippingFeeDisplay');
        }
        
        feeDisplayElement.html(feeDisplayHtml);
        
        // Hi·ªÉn th·ªã toast notification n·∫øu c√≥ gi·∫£m gi√°
        if (discountAmount > 0) {
            showSuccess(`${discountMessage} - Ti·∫øt ki·ªám ${discountAmount.toLocaleString()} VNƒê!`);
        }
    }

    // T√≠nh ph√≠ v·∫≠n chuy·ªÉn ƒë·ªông t·ª´ API
    function calculateShippingFee() {
        if (!useShipping) {
            shippingFee = 0;
            $('#shippingFee').val(0);
            updatePaymentInfo();
            return;
        }

        const tinhText = $('#shipTinh option:selected').text() || '';
        const quanText = $('#shipQuan option:selected').text() || '';
        
        // Ch·ªâ t√≠nh ph√≠ khi ƒë√£ ch·ªçn ƒë·ªß t·ªânh v√† qu·∫≠n
        if (!tinhText || tinhText === 'T·ªânh Th√†nh' || !quanText || quanText === 'Qu·∫≠n Huy·ªán') {
            shippingFee = 0;
            $('#shippingFee').val(0);
            $('#shippingFeeDisplay').html('');
            return; // Kh√¥ng g·ªçi updatePaymentInfo ƒë·ªÉ tr√°nh v√≤ng l·∫∑p
        }

        // L·∫•y t·ªïng gi√° tr·ªã ƒë∆°n h√†ng
        let gh = gioHangs[currentGioHang];
        let orderValue = gh && gh.products ? gh.products.reduce((sum, p) => sum + p.thanhTien, 0) : 0;

        const requestData = {
            Province: tinhText,
            District: quanText,
            OrderValue: orderValue
        };

        console.log('Sending shipping calculation request:', requestData);
        
        $.ajax({
            url: '/api/Shipping/calculate',
            method: 'POST',
            contentType: 'application/json',
            data: JSON.stringify(requestData),
            success: function(response) {
                console.log('Shipping calculation response:', response);
                if (response && response.finalFee !== undefined) {
                    shippingFee = response.finalFee;
                    $('#shippingFee').val(shippingFee);
                    
                    // Hi·ªÉn th·ªã th√¥ng tin chi ti·∫øt ph√≠ v·∫≠n chuy·ªÉn
                    updateShippingFeeDisplay(response);
                    
                    // C·∫≠p nh·∫≠t payment info nh∆∞ng kh√¥ng g·ªçi l·∫°i calculateShippingFee
                    updatePaymentInfoWithoutRecalculation();
                } else {
                    console.error('Invalid shipping response:', response);
                    shippingFee = 50000; // Fallback ph√≠ m·∫∑c ƒë·ªãnh
                    $('#shippingFee').val(shippingFee);
                    updatePaymentInfoWithoutRecalculation();
                }
            },
            error: function(xhr, status, error) {
                console.error('Error calculating shipping fee:', {
                    status: xhr.status,
                    statusText: xhr.statusText,
                    responseText: xhr.responseText,
                    error: error
                });
                
                // Fallback ph√≠ m·∫∑c ƒë·ªãnh khi l·ªói API
                shippingFee = 50000;
                $('#shippingFee').val(shippingFee);
                
                // Hi·ªÉn th·ªã ph√≠ m·∫∑c ƒë·ªãnh
                updateShippingFeeDisplay({
                    originalFee: 50000,
                    finalFee: 50000,
                    discountAmount: 0,
                    discountMessage: ''
                });
                
                updatePaymentInfoWithoutRecalculation();
                showWarning('Kh√¥ng th·ªÉ t√≠nh ph√≠ v·∫≠n chuy·ªÉn ch√≠nh x√°c. S·ª≠ d·ª•ng ph√≠ m·∫∑c ƒë·ªãnh 50.000 VNƒê');
            }
        });
    }

    // Gh√©p chu·ªói ƒë·ªãa ch·ªâ ƒë·∫ßy ƒë·ªß t·ª´ c√°c th√†nh ph·∫ßn cho shipping form
    function concatenateShippingAddress() {
        try {
            const diaChiChiTiet = $('#shipDiaChiChiTiet').val() ? $('#shipDiaChiChiTiet').val().trim() : '';
            const phuongText = $('#shipPhuong option:selected').text() || '';
            const quanText = $('#shipQuan option:selected').text() || '';
            const tinhText = $('#shipTinh option:selected').text() || '';
            
            console.log('Concatenating address:', {
                diaChiChiTiet,
                phuongText,
                quanText,
                tinhText
            });
            
            let fullAddress = '';
            
            if (diaChiChiTiet && diaChiChiTiet !== '') {
                fullAddress += diaChiChiTiet;
            }
            
            if (phuongText && phuongText !== 'Ph∆∞·ªùng X√£' && phuongText !== '') {
                fullAddress += (fullAddress ? ', ' : '') + phuongText;
            }
            
            if (quanText && quanText !== 'Qu·∫≠n Huy·ªán' && quanText !== '') {
                fullAddress += (fullAddress ? ', ' : '') + quanText;
            }
            
            if (tinhText && tinhText !== 'T·ªânh Th√†nh' && tinhText !== '') {
                fullAddress += (fullAddress ? ', ' : '') + tinhText;
            }
            
            console.log('Final address:', fullAddress);
            $('#shipAddress').val(fullAddress);
            
            // T√≠nh l·∫°i ph√≠ v·∫≠n chuy·ªÉn khi ƒë·ªãa ch·ªâ thay ƒë·ªïi
            if (fullAddress && useShipping) {
                calculateShippingFee();
            }
        } catch (error) {
            console.error('Error in concatenateShippingAddress:', error);
        }
    }

    // Gh√©p chu·ªói ƒë·ªãa ch·ªâ ƒë·∫ßy ƒë·ªß t·ª´ c√°c th√†nh ph·∫ßn (legacy function)
    function concatenateFullAddress() {
        concatenateShippingAddress();
    }

    // Parse ƒë·ªãa ch·ªâ t·ª´ chu·ªói ƒë·ªÉ t√°ch t·ªânh/qu·∫≠n/ph∆∞·ªùng (nh∆∞ checkout)
    function parseAddressString(addressString) {
        if (!addressString || addressString.trim() === '') {
            return { success: false };
        }
        
        // T√°ch ƒë·ªãa ch·ªâ theo d·∫•u ph·∫©y
        const parts = addressString.split(',').map(part => part.trim());
        
        if (parts.length >= 3) {
            // Gi·∫£ ƒë·ªãnh format: [Chi ti·∫øt], [Ph∆∞·ªùng], [Qu·∫≠n], [T·ªânh]
            const chiTiet = parts[0];
            const phuong = parts[parts.length - 3];
            const quan = parts[parts.length - 2];
            const tinh = parts[parts.length - 1];
            
            return {
                success: true,
                chiTiet: chiTiet,
                phuong: phuong,
                quan: quan,
                tinh: tinh
            };
        }
        
        return { success: false };
    }

    // ƒêi·ªÅn th√¥ng tin v√†o dropdown t·ª´ ƒë·ªãa ch·ªâ ƒë√£ parse (nh∆∞ checkout)
    async function populateDropdownsFromParsedAddress(parsedAddress) {
        try {
            // ƒêi·ªÅn chi ti·∫øt tr∆∞·ªõc
            document.getElementById('shipDiaChiChiTiet').value = parsedAddress.chiTiet;
            
            // T√¨m v√† ch·ªçn t·ªânh
            const tinhOptions = document.getElementById('shipTinh').options;
            let selectedTinhId = null;
            
            for (let i = 0; i < tinhOptions.length; i++) {
                if (tinhOptions[i].text.includes(parsedAddress.tinh) || parsedAddress.tinh.includes(tinhOptions[i].text)) {
                    selectedTinhId = tinhOptions[i].value;
                    document.getElementById('shipTinh').value = selectedTinhId;
                    break;
                }
            }
            
            if (selectedTinhId && selectedTinhId !== '0') {
                // Load qu·∫≠n huy·ªán cho t·ªânh ƒë√£ ch·ªçn
                const data_quan = await $.getJSON('https://esgoo.net/api-tinhthanh/2/' + selectedTinhId + '.htm');
                if (data_quan.error == 0) {
                    $("#shipQuan").html('<option value="0">Qu·∫≠n Huy·ªán</option>');
                    $("#shipPhuong").html('<option value="0">Ph∆∞·ªùng X√£</option>');
                    
                    let selectedQuanId = null;
                    $.each(data_quan.data, function(key_quan, val_quan) {
                        $("#shipQuan").append('<option value="' + val_quan.id + '">' + val_quan.full_name + '</option>');
                        
                        // T√¨m qu·∫≠n ph√π h·ª£p
                        if (val_quan.full_name.includes(parsedAddress.quan) || parsedAddress.quan.includes(val_quan.full_name)) {
                            selectedQuanId = val_quan.id;
                        }
                    });
                    
                    if (selectedQuanId) {
                        document.getElementById('shipQuan').value = selectedQuanId;
                        
                        // Load ph∆∞·ªùng x√£ cho qu·∫≠n ƒë√£ ch·ªçn
                        const data_phuong = await $.getJSON('https://esgoo.net/api-tinhthanh/3/' + selectedQuanId + '.htm');
                        if (data_phuong.error == 0) {
                            $("#shipPhuong").html('<option value="0">Ph∆∞·ªùng X√£</option>');
                            
                            $.each(data_phuong.data, function(key_phuong, val_phuong) {
                                $("#shipPhuong").append('<option value="' + val_phuong.id + '">' + val_phuong.full_name + '</option>');
                                
                                // T√¨m ph∆∞·ªùng ph√π h·ª£p
                                if (val_phuong.full_name.includes(parsedAddress.phuong) || parsedAddress.phuong.includes(val_phuong.full_name)) {
                                    document.getElementById('shipPhuong').value = val_phuong.id;
                                }
                            });
                        }
                    }
                }
            }
            
            // C·∫≠p nh·∫≠t ƒë·ªãa ch·ªâ ƒë·∫ßy ƒë·ªß sau khi ƒëi·ªÅn xong
            setTimeout(() => {
                concatenateShippingAddress();
            }, 200);
            
        } catch (error) {
            console.error('Error populating dropdowns from parsed address:', error);
        }
    }

    // Populate ƒë·ªãa ch·ªâ t·ª´ chu·ªói ƒë·∫ßy ƒë·ªß v√†o dropdown (s·ª≠ d·ª•ng logic m·ªõi)
    async function populateAddressFromString(fullAddress) {
        if (!fullAddress) return;
        
        try {
            // Parse ƒë·ªãa ch·ªâ
            const parsedAddress = parseAddressString(fullAddress);
            
            if (parsedAddress.success) {
                // S·ª≠ d·ª•ng logic m·ªõi ƒë·ªÉ ƒëi·ªÅn dropdown
                await populateDropdownsFromParsedAddress(parsedAddress);
            } else {
                // Fallback: ƒëi·ªÅn tr·ª±c ti·∫øp v√†o √¥ ƒë·ªãa ch·ªâ
                $('#shipAddress').val(fullAddress);
            }
        } catch (error) {
            console.error('Error populating address from string:', error);
            // Fallback: ƒëi·ªÅn tr·ª±c ti·∫øp v√†o √¥ ƒë·ªãa ch·ªâ
            $('#shipAddress').val(fullAddress);
        }
    }

    // ===== ESGOO.NET ADDRESS DROPDOWN INTEGRATION =====
    
    // Load t·ªânh th√†nh t·ª´ esgoo.net API
    function loadProvinces() {
        $.get("https://esgoo.net/api-tinhthanh/1/0.htm", function(data) {
            if (data.error === 0) {
                // Load cho form ch√≠nh
                if (document.getElementById('shipTinh')) {
                    let html = '<option value="0">T·ªânh Th√†nh</option>';
                    data.data.forEach(function(province) {
                        html += `<option value="${province.id}">${province.full_name}</option>`;
                    });
                    document.getElementById('shipTinh').innerHTML = html;
                }
                
                // Load cho modal l∆∞u ƒë·ªãa ch·ªâ
                if (document.getElementById('saveAddressTinh')) {
                    let html = '<option value="0">T·ªânh Th√†nh</option>';
                    data.data.forEach(function(province) {
                        html += `<option value="${province.id}">${province.full_name}</option>`;
                    });
                    document.getElementById('saveAddressTinh').innerHTML = html;
                }
            }
        }).fail(function() {
            console.error('Kh√¥ng th·ªÉ t·∫£i danh s√°ch t·ªânh th√†nh t·ª´ esgoo.net');
        });
    }

    // Load qu·∫≠n huy·ªán d·ª±a tr√™n t·ªânh th√†nh
    function loadDistricts(provinceId, targetSelectId) {
        if (provinceId === "0") {
            document.getElementById(targetSelectId).innerHTML = '<option value="0">Qu·∫≠n Huy·ªán</option>';
            // Reset ph∆∞·ªùng x√£
            const wardSelectId = targetSelectId.replace('Quan', 'Phuong');
            if (document.getElementById(wardSelectId)) {
                document.getElementById(wardSelectId).innerHTML = '<option value="0">Ph∆∞·ªùng X√£</option>';
            }
            return;
        }

        $.get(`https://esgoo.net/api-tinhthanh/2/${provinceId}.htm`, function(data) {
            if (data.error === 0) {
                let html = '<option value="0">Qu·∫≠n Huy·ªán</option>';
                data.data.forEach(function(district) {
                    html += `<option value="${district.id}">${district.full_name}</option>`;
                });
                document.getElementById(targetSelectId).innerHTML = html;
                
                // Reset ph∆∞·ªùng x√£
                const wardSelectId = targetSelectId.replace('Quan', 'Phuong');
                if (document.getElementById(wardSelectId)) {
                    document.getElementById(wardSelectId).innerHTML = '<option value="0">Ph∆∞·ªùng X√£</option>';
                }
            }
        });
    }

    // Load ph∆∞·ªùng x√£ d·ª±a tr√™n qu·∫≠n huy·ªán
    function loadWards(districtId, targetSelectId) {
        if (districtId === "0") {
            document.getElementById(targetSelectId).innerHTML = '<option value="0">Ph∆∞·ªùng X√£</option>';
            return;
        }

        $.get(`https://esgoo.net/api-tinhthanh/3/${districtId}.htm`, function(data) {
            if (data.error === 0) {
                let html = '<option value="0">Ph∆∞·ªùng X√£</option>';
                data.data.forEach(function(ward) {
                    html += `<option value="${ward.id}">${ward.full_name}</option>`;
                });
                document.getElementById(targetSelectId).innerHTML = html;
            }
        });
    }

    // C·∫≠p nh·∫≠t ƒë·ªãa ch·ªâ ƒë·∫ßy ƒë·ªß cho modal l∆∞u ƒë·ªãa ch·ªâ
    function updateSaveAddressDetail() {
        const diaChiChiTiet = $('#saveAddressChiTiet').val().trim();
        const phuongText = $('#saveAddressPhuong option:selected').text();
        const quanText = $('#saveAddressQuan option:selected').text();
        const tinhText = $('#saveAddressTinh option:selected').text();
        
        let fullAddress = '';
        
        if (diaChiChiTiet) {
            fullAddress += diaChiChiTiet;
        }
        
        if (phuongText && phuongText !== 'Ph∆∞·ªùng X√£') {
            fullAddress += (fullAddress ? ', ' : '') + phuongText;
        }
        
        if (quanText && quanText !== 'Qu·∫≠n Huy·ªán') {
            fullAddress += (fullAddress ? ', ' : '') + quanText;
        }
        
        if (tinhText && tinhText !== 'T·ªânh Th√†nh') {
            fullAddress += (fullAddress ? ', ' : '') + tinhText;
        }
        
        $('#saveAddressDetail').val(fullAddress);
    }

    // Reset dropdown cho modal l∆∞u ƒë·ªãa ch·ªâ
    function resetSaveAddressDropdowns() {
        if (document.getElementById('saveAddressTinh')) {
            document.getElementById('saveAddressTinh').value = '0';
            document.getElementById('saveAddressQuan').innerHTML = '<option value="0">Qu·∫≠n Huy·ªán</option>';
            document.getElementById('saveAddressPhuong').innerHTML = '<option value="0">Ph∆∞·ªùng X√£</option>';
            document.getElementById('saveAddressChiTiet').value = '';
            document.getElementById('saveAddressDetail').value = '';
        }
    }

    // Document ready - thi·∫øt l·∫≠p event handlers cho dropdown
    $(document).ready(function() {
        // Load t·ªânh th√†nh khi trang ƒë∆∞·ª£c t·∫£i
        setTimeout(function() {
            loadProvinces();
        }, 500);
        
        // Event handlers cho form ch√≠nh
        $(document).on('change', '#shipTinh', function() {
            console.log('T·ªânh thay ƒë·ªïi:', this.value);
            loadDistricts(this.value, 'shipQuan');
            setTimeout(concatenateShippingAddress, 100);
        });
        
        $(document).on('change', '#shipQuan', function() {
            console.log('Qu·∫≠n thay ƒë·ªïi:', this.value);
            loadWards(this.value, 'shipPhuong');
            setTimeout(concatenateShippingAddress, 100);
        });
        
        $(document).on('change', '#shipPhuong', function() {
            console.log('Ph∆∞·ªùng thay ƒë·ªïi:', this.value);
            setTimeout(concatenateShippingAddress, 100);
        });
        
        $(document).on('input keyup', '#shipDiaChiChiTiet', function() {
            console.log('ƒê·ªãa ch·ªâ chi ti·∫øt thay ƒë·ªïi:', this.value);
            setTimeout(concatenateShippingAddress, 100);
        });
        
        // Event handlers cho modal l∆∞u ƒë·ªãa ch·ªâ
        $(document).on('change', '#saveAddressTinh', function() {
            loadDistricts(this.value, 'saveAddressQuan');
            updateSaveAddressDetail();
        });
        
        $(document).on('change', '#saveAddressQuan', function() {
            loadWards(this.value, 'saveAddressPhuong');
            updateSaveAddressDetail();
        });
        
        $(document).on('change', '#saveAddressPhuong', function() {
            updateSaveAddressDetail();
        });
        
        $(document).on('input', '#saveAddressChiTiet', function() {
            updateSaveAddressDetail();
        });
        
        // Reset modal khi ƒë√≥ng
        $('#saveAddressModal').on('hidden.bs.modal', function() {
            resetSaveAddressDropdowns();
            $('#saveAddressName').val('');
            $('#saveAddressPhone').val('');
            $('#saveAddressDefault').prop('checked', false);
        });
    });
</script>

<!-- Modal Ch·ªçn ƒê·ªãa Ch·ªâ -->
<div class="modal fade" id="selectAddressModal" tabindex="-1" aria-labelledby="selectAddressModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="selectAddressModalLabel">
                    <i class="fa fa-map-marker"></i> Ch·ªçn ƒë·ªãa ch·ªâ giao h√†ng
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div id="addressList">
                    <div class="text-center">
                        <div class="spinner-border" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <p class="mt-2">ƒêang t·∫£i danh s√°ch ƒë·ªãa ch·ªâ...</p>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ƒê√≥ng</button>
                <button type="button" class="btn btn-primary" onclick="openSaveAddressModal()">
                    <i class="fa fa-plus"></i> Th√™m ƒë·ªãa ch·ªâ m·ªõi
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal L∆∞u ƒê·ªãa Ch·ªâ M·ªõi -->
<div class="modal fade" id="saveAddressModal" tabindex="-1" aria-labelledby="saveAddressModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="saveAddressModalLabel">
                    <i class="fa fa-save"></i> L∆∞u ƒë·ªãa ch·ªâ m·ªõi
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="form-group mb-3">
                    <label class="form-label">T√™n ng∆∞·ªùi nh·∫≠n <span class="text-danger">*</span></label>
                    <input type="text" class="form-control" id="saveAddressName" placeholder="Nh·∫≠p t√™n ng∆∞·ªùi nh·∫≠n">
                </div>
                <div class="form-group mb-3">
                    <label class="form-label">S·ªë ƒëi·ªán tho·∫°i</label>
                    <input type="tel" class="form-control" id="saveAddressPhone" placeholder="Nh·∫≠p s·ªë ƒëi·ªán tho·∫°i">
                </div>
                <div class="form-group mb-3">
                    <label class="form-label">ƒê·ªãa ch·ªâ giao h√†ng <span class="text-danger">*</span></label>
                    
                    <!-- Dropdown ch·ªçn t·ªânh th√†nh, qu·∫≠n huy·ªán, ph∆∞·ªùng x√£ cho modal -->
                    <div class="css_select_div mb-3">
                        <select class="css_select form-control" id="saveAddressTinh" name="saveAddressTinh" title="Ch·ªçn T·ªânh Th√†nh">
                            <option value="0">T·ªânh Th√†nh</option>
                        </select> 
                        <select class="css_select form-control" id="saveAddressQuan" name="saveAddressQuan" title="Ch·ªçn Qu·∫≠n Huy·ªán">
                            <option value="0">Qu·∫≠n Huy·ªán</option>
                        </select> 
                        <select class="css_select form-control" id="saveAddressPhuong" name="saveAddressPhuong" title="Ch·ªçn Ph∆∞·ªùng X√£">
                            <option value="0">Ph∆∞·ªùng X√£</option>
                        </select>
                    </div>
                    
                    <!-- ƒê·ªãa ch·ªâ chi ti·∫øt -->
                    <input type="text" class="form-control mb-2" id="saveAddressChiTiet" name="saveAddressChiTiet" placeholder="S·ªë nh√†, t√™n ƒë∆∞·ªùng...">
                    
                    <!-- ƒê·ªãa ch·ªâ ƒë·∫ßy ƒë·ªß (readonly) -->
                    <textarea class="form-control" id="saveAddressDetail" rows="3" readonly placeholder="ƒê·ªãa ch·ªâ ƒë·∫ßy ƒë·ªß s·∫Ω hi·ªÉn th·ªã ·ªü ƒë√¢y"></textarea>
                </div>
                <div class="form-check">
                    <input type="checkbox" class="form-check-input" id="saveAddressDefault">
                    <label class="form-check-label" for="saveAddressDefault">
                        ƒê·∫∑t l√†m ƒë·ªãa ch·ªâ m·∫∑c ƒë·ªãnh
                    </label>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">H·ªßy</button>
                <button type="button" class="btn btn-primary" onclick="saveNewAddress()">
                    <i class="fa fa-save"></i> L∆∞u ƒë·ªãa ch·ªâ
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Hidden input for selected address ID -->
<input type="hidden" id="selectedAddressId" />