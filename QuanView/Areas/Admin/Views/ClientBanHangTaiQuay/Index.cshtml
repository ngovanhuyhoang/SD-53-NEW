@{
    ViewBag.Title = "B√°n h√†ng";
}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" />
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">

<div class="container mt-3">
    <div class="d-flex justify-content-between align-items-center mb-2">
        <ul class="nav nav-tabs" id="invoiceTabs"></ul>
        <button class="btn btn-primary" id="btnAddInvoice">+ T·∫°o h√≥a ƒë∆°n</button>
    </div>
    <div class="d-flex justify-content-end mb-2">
        <button class="btn btn-info me-2" id="btnQRCode">QR Code</button>
        <button class="btn btn-success" id="btnAddProduct">Th√™m s·∫£n ph·∫©m</button>
    </div>
    <div id="invoiceContent"></div>
    <div class="row mt-4">
        <div class="col-md-7">
            <div class="card mb-3">
                <div class="card-header fw-bold">T√†i kho·∫£n</div>
                <div class="card-body" id="accountInfo">
                    <div class="mb-2">
                        <span class="fw-bold">T√™n kh√°ch h√†ng:</span>
                        <span id="customerName" class="badge bg-secondary">kh√°ch l·∫ª</span>
                    </div>
                    <div id="customerDetails" style="display:none;">
                        <div><span class="fw-bold">S·ªë ƒëi·ªán tho·∫°i:</span> <span id="customerPhone"></span></div>
                        <div><span class="fw-bold">email:</span> <span id="customerEmail"></span></div>
                    </div>
                    <button class="btn btn-outline-secondary btn-sm mt-2" onclick="showCustomerModal()">Ch·ªçn t√†i kho·∫£n</button>
                    <button class="btn btn-outline-secondary btn-sm mt-2 float-end" id="btnShowAddress" style="display:none;" onclick="focusAddressForm()">Ch·ªçn ƒë·ªãa ch·ªâ</button>
                </div>
            </div>

            <!-- Form nh·∫≠p ƒë·ªãa ch·ªâ giao h√†ng -->
            <div class="card mb-3" id="shippingFormCard" style="display:none;">
                <div class="card-header fw-bold">Kh√°ch h√†ng</div>
                <div class="card-body">
                    <div class="mb-2">
                        <input type="text" class="form-control" id="shipName" placeholder="Nh·∫≠p h·ªç v√† t√™n">
                    </div>
                    <div class="mb-2">
                        <input type="text" class="form-control" id="shipPhone" placeholder="Nh·∫≠p s·ªë ƒëi·ªán tho·∫°i">
                    </div>
                    <div class="mb-2">
                        <input type="email" class="form-control" id="shipEmail" placeholder="Nh·∫≠p email">
                    </div>
                    <div class="mb-2">
                        <input type="text" class="form-control" id="shipAddress" placeholder="Nh·∫≠p ƒë·ªãa ch·ªâ">
                    </div>
                    <div class="row mb-2">
                        <div class="col">
                            <select class="form-select" id="shipProvince">
                                <option>Ch·ªçn t·ªânh</option>
                            </select>
                        </div>
                        <div class="col">
                            <select class="form-select" id="shipDistrict">
                                <option>Ch·ªçn Qu·∫≠n</option>
                            </select>
                        </div>
                        <div class="col">
                            <select class="form-select" id="shipWard">
                                <option>Ch·ªçn Ph∆∞·ªùng x√£</option>
                            </select>
                        </div>
                    </div>
                    <div class="mb-2">
                        <input type="text" class="form-control" id="shipNote" placeholder="Ghi ch√∫">
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-5">
            <div class="card">
                <div class="card-header fw-bold"><i class="bi bi-bag"></i> Th√¥ng tin thanh to√°n</div>
                <div class="card-body">
                    <div class="mb-2">
                    <span>Kh√°ch c·∫ßn thanh to√°n</span>
    <span class="float-end fw-bold" id="payAmount">0 VND</span>
</div>
                
                    <div class="mb-2">
                        <span>Ti·ªÅn th·ªëi l·∫°i:</span>
                        <span class="float-end fw-bold text-success" id="changeAmount">0 VND</span>
                    </div>
                    <div class="mb-2">
                        <label class="form-label">M√£ gi·∫£m gi√°:</label>
                        <div class="input-group">
                            <input type="text" class="form-control" id="discountCode" value="" placeholder="Ch·ªçn phi·∫øu gi·∫£m gi√°" readonly>
                            <button class="btn btn-outline-secondary" type="button" onclick="applyDiscount()">Ch·ªçn m√£</button>
                            <button class="btn btn-outline-danger" type="button" onclick="clearDiscount()" title="X√≥a phi·∫øu gi·∫£m gi√°">
                                <i class="bi bi-x-lg"></i>
                            </button>
                        </div>
                    </div>
                    <div class="form-check form-switch mb-2">
                        <input class="form-check-input" type="checkbox" id="shippingSwitch" onchange="toggleShipping()">
                        <label class="form-check-label" for="shippingSwitch">Giao H√†ng</label>
                    </div>
                    <div class="mb-2">
                        <span>Ti·ªÅn h√†ng:</span>
                        <span class="float-end" id="goodsAmount">0 VND</span>
                    </div>
                    <div class="mb-2">
                        <span>Gi·∫£m gi√°:</span>
                        <span class="float-end text-success" id="discountAmount">0 VND</span>
                    </div>
                    <div class="form-check form-switch mb-2">
                        <input class="form-check-input" type="checkbox" id="pointSwitch" onchange="togglePoint()">
                        <label class="form-check-label" for="pointSwitch">ƒêi·ªÉm hi·ªán t·∫°i l√† <span id="customerPoint">0</span>:</label>
                    </div>
                    <div class="mb-2 d-flex align-items-center">
    <span>H√¨nh th·ª©c thanh to√°n:</span>
    <span class="ms-auto d-flex align-items-center">
        <span id="selectedPaymentMethod">Ti·ªÅn m·∫∑t</span>
        <a href="javascript:void(0)" onclick="openPaymentModal()" class="ms-2" title="Ch·ªânh s·ª≠a">
            <i class="bi bi-pencil-square" style="font-size: 1.2em; cursor: pointer;"></i>
        </a>
    </span>
</div>
                    <div class="mb-2">
                        <span class="fw-bold">T·ªïng ti·ªÅn:</span>
                        <span class="float-end fw-bold text-danger" id="totalAmount">0 VND</span>
                    </div>
                   <button class="btn btn-primary w-100" onclick="payInvoice()">Thanh to√°n</button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal ch·ªçn s·∫£n ph·∫©m -->
<div class="modal fade" id="productModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Ch·ªçn s·∫£n ph·∫©m</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="productList">
                <!-- Danh s√°ch s·∫£n ph·∫©m s·∫Ω ƒë∆∞·ª£c load ·ªü ƒë√¢y -->
            </div>
        </div>
    </div>
</div>

<!-- Modal ch·ªçn kh√°ch h√†ng -->
<div class="modal fade" id="customerModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Kh√°ch h√†ng</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <input type="text" class="form-control mb-2" id="searchCustomer" placeholder="T√¨m ki·∫øm theo s·ªë ƒëi·ªán tho·∫°i, t√™n">
                <button class="btn btn-primary mb-2" onclick="searchCustomer()">T√¨m ki·∫øm</button>
                <table class="table table-bordered">
                    <thead>
                        <tr>
                            <th>STT</th>
                            <th>·∫¢nh</th>
                            <th>T√™n kh√°ch h√†ng</th>
                            <th>Email</th>
                            <th>S·ªë ƒëi·ªán tho·∫°i</th>
                            <th>ƒêi·ªÉm</th>
                            <th>H√†nh ƒë·ªông</th>
                        </tr>
                    </thead>
                    <tbody id="customerList"></tbody>
                </table>
                <button class="btn btn-secondary" data-bs-dismiss="modal">H·ªßy</button>
                <button class="btn btn-success float-end" onclick="addNewCustomer()">Th√™m kh√°ch h√†ng</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal x√°c nh·∫≠n thanh to√°n -->
<div class="modal fade" id="confirmPaymentModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Thanh to√°n</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-2">
                    <span>S·ªë ti·ªÅn ph·∫£i thanh to√°n:</span>
                    <span class="float-end fw-bold" id="modalPayAmount">0 ƒë</span>
                </div>
                <div class="mb-2">
                    <label class="form-label">H√¨nh th·ª©c thanh to√°n</label>
                    <select class="form-select" id="paymentMethod">
                        <!-- Option s·∫Ω ƒë∆∞·ª£c load ƒë·ªông t·ª´ API -->
                    </select>
                </div>
                <div class="mb-2">
                    <label class="form-label">Ti·ªÅn kh√°ch ƒë∆∞a</label>
                    <input type="number" class="form-control" id="modalCustomerPaid" min="0" value="0" oninput="updateModalChangeAmount()" />
                </div>
                <div class="mb-2">
                    <span>Ti·ªÅn th·ªëi l·∫°i:</span>
                    <span class="float-end fw-bold text-success" id="modalChangeAmount">0 ƒë</span>
                </div>
                <!-- C√≥ th·ªÉ th√™m b·∫£ng l·ªãch s·ª≠ giao d·ªãch n·∫øu c·∫ßn -->
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" data-bs-dismiss="modal">H·ªßy b·ªè</button>
                <button class="btn btn-primary" onclick="updatePaymentInfoFromModal()">X√°c nh·∫≠n</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal ch·ªçn phi·∫øu gi·∫£m gi√° -->
<div class="modal fade" id="discountVoucherModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Ch·ªçn phi·∫øu gi·∫£m gi√°</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="voucherList">
                    <!-- Danh s√°ch phi·∫øu gi·∫£m gi√° s·∫Ω ƒë∆∞·ª£c load ·ªü ƒë√¢y -->
                </div>
                <div id="noVoucherMessage" style="display:none;" class="text-center py-4">
                    <i class="bi bi-ticket-perforated" style="font-size: 3rem; color: #ccc;"></i>
                    <p class="mt-2 text-muted">Kh√°ch h√†ng ch∆∞a c√≥ phi·∫øu gi·∫£m gi√° n√†o</p>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" data-bs-dismiss="modal">ƒê√≥ng</button>
            </div>
        </div>
    </div>
</div>

<script>
    let invoices = [];
    let currentInvoice = 0;
    const maxInvoices = 5;

    // D·ªØ li·ªáu ƒë·ªông
    let products = [];
    let customers = [];
    let selectedCustomer = null;
    let discountValue = 0;
    let useShipping = false;
    let usePoint = false;
    let selectedPaymentCode;

    // L∆∞u h√≥a ƒë∆°n v√†o localStorage
    function saveInvoicesToStorage() {
        localStorage.setItem('invoices', JSON.stringify(invoices));
    }

    // Load s·∫£n ph·∫©m t·ª´ API
    function loadProducts() {
        $.get('/Admin/ClientBanHangTaiQuay/danh-sach-san-pham', function(data) {
            products = data;
        });
    }

    // Load kh√°ch h√†ng t·ª´ API
    function loadCustomers(callback) {
        $.get('/Admin/ClientBanHangTaiQuay/danh-sach-khach-hang', function(data) {
            customers = data;
            if (callback) callback();
        });
    }

    // T√¨m ki·∫øm kh√°ch h√†ng
    function searchCustomer() {
        let q = $('#searchCustomer').val();
        if (!q) {
            renderCustomerList(customers);
            return;
        }
        $.get('/Admin/ClientBanHangTaiQuay/tim-kiem-khach-hang', { query: q }, function(data) {
            renderCustomerList(data);
        });
    }

    // Th√™m kh√°ch h√†ng m·ªõi
    function addNewCustomer() {
        let name = prompt('Nh·∫≠p t√™n kh√°ch h√†ng m·ªõi:');
        let phone = prompt('Nh·∫≠p s·ªë ƒëi·ªán tho·∫°i kh√°ch h√†ng:');
        if (!name || !phone) return alert('Vui l√≤ng nh·∫≠p ƒë·ªß th√¥ng tin!');
        $.ajax({
            url: '/Admin/ClientBanHangTaiQuay/them-khach-hang',
            method: 'POST',
            contentType: 'application/json',
            data: JSON.stringify({ tenKhachHang: name, soDienThoai: phone }),
            success: function(res) {
                loadCustomers(function() {
                    renderCustomerList(customers);
                });
                alert('Th√™m kh√°ch h√†ng th√†nh c√¥ng!');
            },
            error: function(err) {
                alert('Th√™m kh√°ch h√†ng th·∫•t b·∫°i!');
            }
        });
    }

    // √Åp d·ª•ng m√£ gi·∫£m gi√°
    function applyDiscount() {
        if (!selectedCustomer) {
            alert('Vui l√≤ng ch·ªçn kh√°ch h√†ng tr∆∞·ªõc khi ch·ªçn phi·∫øu gi·∫£m gi√°!');
            return;
        }
        
        // Load danh s√°ch phi·∫øu gi·∫£m gi√° c·ªßa kh√°ch h√†ng
        loadCustomerDiscountVouchers();
    }

    // Load danh s√°ch phi·∫øu gi·∫£m gi√° c·ªßa kh√°ch h√†ng
    function loadCustomerDiscountVouchers() {
        $.get('/Admin/ClientBanHangTaiQuay/danh-sach-phieu-giam-gia-khach-hang', { customerId: selectedCustomer.id }, function(data) {
            if (data && data.length > 0) {
                renderVoucherList(data);
                $('#voucherList').show();
                $('#noVoucherMessage').hide();
            } else {
                $('#voucherList').hide();
                $('#noVoucherMessage').show();
            }
            $('#discountVoucherModal').modal('show');
        }).fail(function() {
            alert('L·ªói khi t·∫£i danh s√°ch phi·∫øu gi·∫£m gi√°!');
        });
    }

    // Render danh s√°ch phi·∫øu gi·∫£m gi√°
    function renderVoucherList(vouchers) {
        let html = '<div class="row">';
        vouchers.forEach(function(voucher, index) {
            let isExpired = new Date(voucher.ngayKetThuc) < new Date();
            let isActive = !isExpired && new Date(voucher.ngayBatDau) <= new Date();
            
            html += `
                <div class="col-md-6 mb-3">
                    <div class="card ${isExpired ? 'border-danger' : isActive ? 'border-success' : 'border-warning'} h-100">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h6 class="mb-0">${voucher.tenPhieu}</h6>
                            <span class="badge ${isExpired ? 'bg-danger' : isActive ? 'bg-success' : 'bg-warning'}">
                                ${isExpired ? 'H·∫øt h·∫°n' : isActive ? 'C√≥ hi·ªáu l·ª±c' : 'Ch∆∞a c√≥ hi·ªáu l·ª±c'}
                            </span>
                        </div>
                        <div class="card-body">
                            <div class="mb-2">
                                <strong>M√£:</strong> <code>${voucher.maCode}</code>
                            </div>
                            <div class="mb-2">
                                <strong>Gi·∫£m gi√°:</strong> ${voucher.giaTriGiam}% (t·ªëi ƒëa ${voucher.giaTriGiamToiDa.toLocaleString()} VND)
                            </div>
                            <div class="mb-2">
                                <strong>ƒê∆°n t·ªëi thi·ªÉu:</strong> ${voucher.donToiThieu.toLocaleString()} VND
                            </div>
                            <div class="mb-2">
                                <strong>Hi·ªáu l·ª±c:</strong> ${new Date(voucher.ngayBatDau).toLocaleDateString('vi-VN')} - ${new Date(voucher.ngayKetThuc).toLocaleDateString('vi-VN')}
                            </div>
                            ${voucher.moTa ? `<div class="mb-2"><strong>M√¥ t·∫£:</strong> ${voucher.moTa}</div>` : ''}
                        </div>
                        <div class="card-footer">
                            <button class="btn btn-primary btn-sm w-100" 
                                    onclick="selectVoucher('${voucher.maCode}', ${voucher.giaTriGiam}, ${voucher.giaTriGiamToiDa}, ${voucher.donToiThieu})"
                                    ${!isActive ? 'disabled' : ''}>
                                ${isActive ? 'Ch·ªçn phi·∫øu n√†y' : 'Kh√¥ng c√≥ hi·ªáu l·ª±c'}
                            </button>
                        </div>
                    </div>
                </div>
            `;
        });
        html += '</div>';
        $('#voucherList').html(html);
    }

    // Ch·ªçn phi·∫øu gi·∫£m gi√°
    function selectVoucher(code, giaTriGiam, giaTriGiamToiDa, donToiThieu) {
        let inv = invoices[currentInvoice];
        let total = inv.products.reduce((sum, p) => sum + p.price * p.qty, 0);
        
        // Ki·ªÉm tra ƒë∆°n t·ªëi thi·ªÉu
        if (total < donToiThieu) {
            alert(`ƒê∆°n h√†ng ph·∫£i c√≥ gi√° tr·ªã t·ªëi thi·ªÉu ${donToiThieu.toLocaleString()} VND ƒë·ªÉ s·ª≠ d·ª•ng phi·∫øu n√†y!`);
            return;
        }
        
        // T√≠nh to√°n gi·∫£m gi√°
        let discountAmount = (total * giaTriGiam / 100);
        if (discountAmount > giaTriGiamToiDa) {
            discountAmount = giaTriGiamToiDa;
        }
        
        // C·∫≠p nh·∫≠t giao di·ªán
        $('#discountCode').val(code);
        discountValue = discountAmount;
        
        // ƒê√≥ng modal
        $('#discountVoucherModal').modal('hide');
        
        // C·∫≠p nh·∫≠t th√¥ng tin thanh to√°n
        updatePaymentInfo();
        
        alert(`ƒê√£ √°p d·ª•ng phi·∫øu gi·∫£m gi√° ${code}! Gi·∫£m ${discountAmount.toLocaleString()} VND`);
    }

    // X√≥a phi·∫øu gi·∫£m gi√°
    function clearDiscount() {
        $('#discountCode').val('');
        discountValue = 0;
        updatePaymentInfo();
    }

    // Thanh to√°n h√≥a ƒë∆°n
    function openPaymentModal() {
        let pay = $('#payAmount').text();
        $('#modalPayAmount').text(pay);
        $('#modalCustomerPaid').val(pay.replace(/\D/g, ''));
        // ƒê·∫∑t l·∫°i ph∆∞∆°ng th·ª©c thanh to√°n trong modal theo ngo√†i giao di·ªán
        let currentMethod = $('#selectedPaymentMethod').text().trim();
        $('#paymentMethod').val(
            currentMethod === "Ti·ªÅn m·∫∑t" ? "cash" :
            currentMethod === "Chuy·ªÉn kho·∫£n" ? "bank" :
            currentMethod === "Th·∫ª" ? "card" : "cash"
        );
        updateModalChangeAmount();
        $('#confirmPaymentModal').modal('show');
    }

    // Th√™m h√≥a ƒë∆°n m·ªõi
    function addInvoice() {
        invoices.push({products: []});
        currentInvoice = invoices.length - 1;
        saveInvoicesToStorage();
    }

    // Render tabs h√≥a ƒë∆°n
    function renderTabs() {
        let html = '';
        invoices.forEach((inv, idx) => {
            html += `<li class="nav-item">
                <a class="nav-link ${idx === currentInvoice ? 'active' : ''}" href="#" onclick="switchInvoice(${idx})">H√≥a ƒë∆°n ${idx+1}${inv.products.length > 0 ? '<span class=\'badge bg-danger ms-1\'>'+inv.products.length+'</span>' : ''}</a>
            </li>`;
        });
        $('#invoiceTabs').html(html);
    }

    // Chuy·ªÉn h√≥a ƒë∆°n
    function switchInvoice(idx) {
        currentInvoice = idx;
        renderTabs();
        renderInvoice();
    }

    // Render danh s√°ch s·∫£n ph·∫©m trong h√≥a ƒë∆°n
    function renderInvoice() {
        let inv = invoices[currentInvoice];
        if (!inv || inv.products.length === 0) {
            $('#invoiceContent').html(`
                <div class="text-center my-5">
                    <img src="https://cdn-icons-png.flaticon.com/512/1170/1170576.png" width="100" />
                    <p class="mt-3">Kh√¥ng c√≥ s·∫£n ph·∫©m n√†o trong gi·ªè</p>
                </div>
            `);
            return;
        }
        let rows = inv.products.map((p, i) => `
            <tr>
                <td>${i+1}</td>
                <td><img src="${p.img}" width="60"/></td>
                <td>${p.name}<br><small>K√≠ch c·ª°: ${p.size}</small></td>
                <td>
    ${
        (p.originalPrice && p.originalPrice > p.price)
        ? `<div style="display:flex;flex-direction:column;align-items:flex-start;line-height:1.1;">
      <span style="color:#888;text-decoration:line-through;font-size:0.95em;">${p.originalPrice.toLocaleString()} VND</span>
      <span style="color:#d32f2f;font-weight:bold;font-size:1em;">${p.price.toLocaleString()} VND</span>
   </div>`
        : `<span style="font-weight:bold;">${p.price.toLocaleString()} VND</span>`
    }
</td>
                <td>
                    <button class="btn btn-sm btn-light" onclick="changeQty(${i},-1)">-</button>
                    <span class="mx-2">${p.qty}</span>
                    <button class="btn btn-sm btn-light" onclick="changeQty(${i},1)">+</button>
                </td>
                <td>${(p.price * p.qty).toLocaleString()} VND</td>
                <td><button class="btn btn-danger btn-sm" onclick="removeProduct(${i})">üóë</button></td>
            </tr>
        `).join('');
        let total = inv.products.reduce((sum, p) => sum + p.price * p.qty, 0);
        $('#invoiceContent').html(`
            <table class="table table-bordered align-middle">
                <thead>
                    <tr>
                        <th>STT</th><th>·∫¢nh</th><th>S·∫£n ph·∫©m</th><th>Gi√° b√°n</th><th>S·ªë l∆∞·ª£ng</th><th>T·ªïng ti·ªÅn</th><th>Thao t√°c</th>
                    </tr>
                </thead>
                <tbody>${rows}</tbody>
            </table>
            <div class="d-flex justify-content-end">
                <h5 class="me-3">T·ªïng ti·ªÅn: <span class="text-danger">${total.toLocaleString()} VND</span></h5>
            </div>
        `);
        updatePaymentInfo();
    }

    // Thay ƒë·ªïi s·ªë l∆∞·ª£ng s·∫£n ph·∫©m
    function changeQty(idx, delta) {
        let inv = invoices[currentInvoice];
        let prod = inv.products[idx];
        let productInfo = products.find(p => p.id == prod.id);
        let maxQty = productInfo ? productInfo.stock : 1;

        if (prod.qty + delta > maxQty) {
            alert('V∆∞·ª£t qu√° s·ªë l∆∞·ª£ng t·ªìn kho!');
            return;
        }
        prod.qty += delta;
        if (prod.qty < 1) prod.qty = 1;
        renderInvoice();
        saveInvoicesToStorage();
    }

    // X√≥a s·∫£n ph·∫©m kh·ªèi h√≥a ƒë∆°n
    function removeProduct(idx) {
        invoices[currentInvoice].products.splice(idx, 1);
        renderTabs();
        renderInvoice();
        saveInvoicesToStorage();
    }

    // Render modal ch·ªçn s·∫£n ph·∫©m
    function renderProductModal() {
        let html = `<table class="table table-hover">
            <thead>
                <tr>
                    <th>·∫¢nh</th><th>T√™n s·∫£n ph·∫©m</th><th>Gi√° b√°n</th><th>K√≠ch c·ª°</th><th>M√†u s·∫Øc</th><th>H√†nh ƒë·ªông</th>
                </tr>
            </thead>
            <tbody>
                ${products.map(p => `
                    <tr>
                        <td><img src="${p.img}" width="60"/></td>
                        <td>${p.name}</td>
                        <td>
    ${
        (p.originalPrice && p.originalPrice > p.price)
        ? `<span style="display:inline-flex;align-items:center;gap:8px;">
      <span style="color:#888;text-decoration:line-through;font-size:0.95em;">${p.originalPrice.toLocaleString()} VND</span>
      <span style="color:#d32f2f;font-weight:bold;font-size:1em;">${p.price.toLocaleString()} VND</span>
   </span>`
        : `<span style="font-weight:bold;">${p.price.toLocaleString()} VND</span>`
    }
</td>
                        <td>${p.size}</td>
                        <td>${p.color}</td>
                        <td><button class="btn btn-success btn-sm" onclick="addProductToInvoice('${p.id}')">Ch·ªçn</button></td>
                    </tr>
                `).join('')}
            </tbody>
        </table>`;
        $('#productList').html(html);
    }

    // Th√™m s·∫£n ph·∫©m v√†o h√≥a ƒë∆°n
    function addProductToInvoice(productId) {
        let prod = products.find(p => p.id == productId);
        let inv = invoices[currentInvoice];
        let exist = inv.products.find(p => p.id == productId);
        let maxQty = prod.stock || 1; // c·∫ßn c√≥ tr∆∞·ªùng stock

        if (exist) {
            if (exist.qty + 1 > maxQty) {
                alert('V∆∞·ª£t qu√° s·ªë l∆∞·ª£ng t·ªìn kho!');
                return;
            }
            exist.qty += 1;
        } else {
            if (maxQty < 1) {
                alert('S·∫£n ph·∫©m ƒë√£ h·∫øt h√†ng!');
                return;
            }
            inv.products.push({ ...prod, qty: 1 });
        }
        $('#productModal').modal('hide');
        renderTabs();
        renderInvoice();
        saveInvoicesToStorage();
    }

    function showCustomerModal() {
        renderCustomerList(customers);
        $('#customerModal').modal('show');
    }

    function renderCustomerList(list) {
        let html = list.map((c, i) => `
            <tr>
                <td>${i+1}</td>
                <td><img src="${c.img}" width="40" class="rounded-circle"/></td>
                <td>${c.name}</td>
                <td>${c.email}</td>
                <td>${c.phone}</td>
                <td>${c.point}</td>
                <td><button class="btn btn-outline-primary btn-sm" onclick="selectCustomer('${c.id}')">Ch·ªçn</button></td>
            </tr>
        `).join('');
        $('#customerList').html(html);
    }

    function selectCustomer(id) {
        selectedCustomer = customers.find(c => c.id == id);
        $('#customerModal').modal('hide');
        $('#customerName').text(selectedCustomer.name).removeClass('bg-secondary').addClass('bg-info');
        $('#customerDetails').show();
        $('#customerPhone').text(selectedCustomer.phone);
        $('#customerEmail').text(selectedCustomer.email);
        $('#customerPoint').text(selectedCustomer.point);
        
        // Reset phi·∫øu gi·∫£m gi√° khi ch·ªçn kh√°ch h√†ng m·ªõi
        $('#discountCode').val('');
        discountValue = 0;
        
        updatePaymentInfo();
    }

    // Toggle giao h√†ng
    function toggleShipping() {
        useShipping = $('#shippingSwitch').is(':checked');
        if (useShipping) {
            $('#shippingFormCard').show();
            $('#btnShowAddress').show();
        } else {
            $('#shippingFormCard').hide();
            $('#btnShowAddress').hide();
        }
        updatePaymentInfo();
    }


    // Toggle s·ª≠ d·ª•ng ƒëi·ªÉm
    function togglePoint() {
        usePoint = $('#pointSwitch').is(':checked');
        updatePaymentInfo();
    }

    // C·∫≠p nh·∫≠t th√¥ng tin thanh to√°n
    function updatePaymentInfo() {
        let inv = invoices[currentInvoice];
        let total = inv.products.reduce((sum, p) => sum + p.price * p.qty, 0);
        let discount = discountValue || 0;
        let point = (selectedCustomer && usePoint) ? selectedCustomer.point * 1000 : 0; // v√≠ d·ª• 1 ƒëi·ªÉm = 1000 VND
        let shipping = useShipping ? 0 : 0; // b·∫°n c√≥ th·ªÉ th√™m ph√≠ ship n·∫øu mu·ªën
        let pay = total - discount - point + shipping;
        if (pay < 0) pay = 0;

        $('#goodsAmount').text(total.toLocaleString() + " VND");
        $('#discountAmount').text(discount.toLocaleString() + " VND");
        $('#payAmount').text(pay.toLocaleString() + " VND");
        $('#totalAmount').text(pay.toLocaleString() + " VND");
    }

    // G·ªçi l·∫°i khi render h√≥a ƒë∆°n
    let oldRenderInvoice = renderInvoice;
    renderInvoice = function() {
        oldRenderInvoice();
        updatePaymentInfo();
    }

    function updateModalChangeAmount() {
        let pay = parseInt($('#modalPayAmount').text().replace(/\D/g, '')) || 0;
        let customerPaid = parseInt($('#modalCustomerPaid').val()) || 0;
        let change = customerPaid - pay;
        let $change = $('#modalChangeAmount');
        $change.text(change.toLocaleString() + " ƒë");
        if (change < 0) {
            $change.removeClass('text-success').addClass('text-danger');
        } else {
            $change.removeClass('text-danger').addClass('text-success');
        }
    }

        function updatePaymentInfoFromModal() {
        // L·∫•y d·ªØ li·ªáu t·ª´ modal
        selectedPaymentCode = $('#paymentMethod').val();
        let customerPaid = parseInt($('#modalCustomerPaid').val()) || 0;
        let pay = parseInt($('#modalPayAmount').text().replace(/\D/g, '')) || 0;
        let change = customerPaid - pay;

        // C·∫≠p nh·∫≠t ra ngo√†i
        let $change = $('#changeAmount');
        $change.text(change.toLocaleString() + " VND");
        if (change < 0) {
            $change.removeClass('text-success').addClass('text-danger');
        } else {
            $change.removeClass('text-danger').addClass('text-success');
        }

        // Hi·ªÉn th·ªã t√™n ph∆∞∆°ng th·ª©c thanh to√°n ra ngo√†i
        $('#selectedPaymentMethod').text($('#paymentMethod option:selected').text());

        // ƒê√≥ng modal
        $('#confirmPaymentModal').modal('hide');
    }

    function payInvoice() {
        let inv = invoices[currentInvoice];
        if (!inv || inv.products.length === 0) return alert('Kh√¥ng c√≥ s·∫£n ph·∫©m trong h√≥a ƒë∆°n!');

        // L·∫•y l·∫°i c√°c th√¥ng tin ƒë√£ ch·ªçn t·ª´ ngo√†i giao di·ªán
        let paymentMethod = $('#selectedPaymentMethod').text() || "Ti·ªÅn m·∫∑t";
        let customerPaid = parseInt($('#modalCustomerPaid').val()) || 0;
        let pay = parseInt($('#payAmount').text().replace(/\D/g, '')) || 0;

        if (customerPaid < pay) {
            alert('Kh√°ch ƒë∆∞a ch∆∞a ƒë·ªß ti·ªÅn!');
            return;
        }

        // D·ªØ li·ªáu g·ª≠i ƒëi
        let dto = {
            CustomerId: selectedCustomer ? selectedCustomer.id : null,
            CustomerName: selectedCustomer ? selectedCustomer.name : $('#shipName').val(),
            CustomerPhone: selectedCustomer ? selectedCustomer.phone : $('#shipPhone').val(),
            CustomerEmail: selectedCustomer ? selectedCustomer.email : $('#shipEmail').val(),
            Address: $('#shipAddress').val(),
            Products: inv.products.map(p => ({ ProductDetailId: p.id, Quantity: p.qty })),
            DiscountCode: $('#discountCode').val(),
            UsePoint: usePoint,
            Shipping: useShipping,
            PaymentMethod: paymentMethod,
            CustomerPaid: customerPaid
        };
        $.ajax({
            url: '/Admin/ClientBanHangTaiQuay/thanh-toan',
            method: 'POST',
            contentType: 'application/json',
            data: JSON.stringify(dto),
            success: function(res) {
                alert('Thanh to√°n th√†nh c√¥ng!');
                $('#confirmPaymentModal').modal('hide');
                invoices.splice(currentInvoice, 1);
                if (invoices.length === 0) addInvoice();
                currentInvoice = 0;
                renderTabs();
                renderInvoice();
                saveInvoicesToStorage(); // Th√™m d√≤ng n√†y
            },
            error: function(err) {
                alert('Thanh to√°n th·∫•t b·∫°i!');
            }
        });
    }

    // Kh·ªüi t·∫°o t·ªânh (gi·ªØ nguy√™n n·∫øu mu·ªën d·ªØ li·ªáu m·∫´u)
    const provinces = ["H√† N·ªôi", "H·ªì Ch√≠ Minh"];
    const districts = { "H√† N·ªôi": ["Ba ƒê√¨nh", "C·∫ßu Gi·∫•y"], "H·ªì Ch√≠ Minh": ["Qu·∫≠n 1", "Qu·∫≠n 3"] };
    const wards = { "Ba ƒê√¨nh": ["Ph∆∞·ªùng 1", "Ph∆∞·ªùng 2"], "C·∫ßu Gi·∫•y": ["Ph∆∞·ªùng 3", "Ph∆∞·ªùng 4"], "Qu·∫≠n 1": ["Ph∆∞·ªùng 5"], "Qu·∫≠n 3": ["Ph∆∞·ªùng 6"] };
    $('#shipProvince').on('change', function() {
        let val = $(this).val();
        let opts = (districts[val] || []).map(d => `<option>${d}</option>`).join('');
        $('#shipDistrict').html('<option>Ch·ªçn Qu·∫≠n</option>' + opts);
        $('#shipWard').html('<option>Ch·ªçn Ph∆∞·ªùng x√£</option>');
    });
    $('#shipDistrict').on('change', function() {
        let val = $(this).val();
        let opts = (wards[val] || []).map(w => `<option>${w}</option>`).join('');
        $('#shipWard').html('<option>Ch·ªçn Ph∆∞·ªùng x√£</option>' + opts);
    });
    $('#shipProvince').html('<option>Ch·ªçn t·ªânh</option>' + provinces.map(p => `<option>${p}</option>`).join(''));

    // Load ph∆∞∆°ng th·ª©c thanh to√°n ƒë·ªông t·ª´ API
    function loadPaymentMethods() {
        $.get('/api/BanHangTaiQuay/danh-sach-phuong-thuc-thanh-toan', function(data) {
            let html = '';
            data.forEach(function(method) {
                html += `<option value="${method.maPhuongThuc}">${method.tenPhuongThuc}</option>`;
            });
            $('#paymentMethod').html(html);
        });
    }

    // Kh·ªüi t·∫°o h√≥a ƒë∆°n ƒë·∫ßu ti√™n v√† load d·ªØ li·ªáu ƒë·ªông
    $(document).ready(function() {
        let storedInvoices = localStorage.getItem('invoices');
        if (storedInvoices) {
            invoices = JSON.parse(storedInvoices);
            if (invoices.length === 0) addInvoice();
        } else {
            addInvoice();
        }
        renderTabs();
        renderInvoice();
        loadProducts();
        loadCustomers();
        loadPaymentMethods(); // Load ph∆∞∆°ng th·ª©c thanh to√°n ƒë·ªông t·ª´ API

        $('#btnAddInvoice').click(function() {
            if (invoices.length < maxInvoices) {
                addInvoice();
                renderTabs();
                renderInvoice();
            } else {
                alert('Ch·ªâ ƒë∆∞·ª£c t·ªëi ƒëa 5 h√≥a ƒë∆°n ch·ªù!');
            }
        });

        $('#btnAddProduct').click(function() {
            renderProductModal();
            $('#productModal').modal('show');
        });
    });

    function loadPaymentMethods() {
    $.get('/Admin/ClientBanHangTaiQuay/danh-sach-phuong-thuc-thanh-toan', function(data) {
        let html = '';
        data.forEach(function(method) {
            html += `<option value="${method.maPhuongThuc}">${method.tenPhuongThuc}</option>`;
        });
        $('#paymentMethod').html(html);
        // Set m·∫∑c ƒë·ªãnh t·ª´ DB (ph∆∞∆°ng th·ª©c ƒë·∫ßu ti√™n)
        if (data.length > 0) {
            selectedPaymentCode = data[0].maPhuongThuc;
            $('#selectedPaymentMethod').text(data[0].tenPhuongThuc);
            $('#paymentMethod').val(selectedPaymentCode);
        }
    });
}
</script>