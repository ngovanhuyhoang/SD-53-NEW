    @model QuanApi.Data.DotGiamGia

    @{
        ViewData["Title"] = "T·∫°o m·ªõi ƒë·ª£t gi·∫£m gi√°";
    }

    <div class="container py-4">
        <div class="card shadow-lg border-0 rounded-4">
            <div class="card-header bg-primary text-white rounded-top-4">
                <h3 class="mb-0"><i class="bi bi-tags-fill me-2"></i>@ViewData["Title"]</h3>
            </div>
            <div class="card-body">
                <form asp-action="Create" method="post">
                    @if (!ViewData.ModelState.IsValid)
                    {
                        <div class="alert alert-danger">
                            @foreach (var error in ViewData.ModelState.Values.SelectMany(v => v.Errors))
                            {
                                <div>@error.ErrorMessage</div>
                            }
                        </div>
                    }

                    <div class="row g-3">
                        <div class="col-md-6">
                            <label asp-for="MaDot" class="form-label">M√£ khuy·∫øn m√£i</label>
                            <div class="input-group">
                                <input asp-for="MaDot" class="form-control" readonly style="background-color: #f8f9fa;" />
                                <button type="button" class="btn btn-outline-primary" onclick="generateMaDot()">T·∫°o m√£</button>
                            </div>
                            <span asp-validation-for="MaDot" class="text-danger small"></span>
                        </div>

                        <div class="col-md-6">
                            <label asp-for="TenDot" class="form-label">T√™n ƒë·ª£t gi·∫£m gi√°</label>
                            <input asp-for="TenDot" class="form-control" />
                            <span asp-validation-for="TenDot" class="text-danger small"></span>
                        </div>

                        <div class="col-md-4">
                            <label asp-for="PhanTramGiam" class="form-label">Gi·∫£m (%)</label>
                            <input asp-for="PhanTramGiam" type="number" min="1" max="40" step="0.01" class="form-control" oninput="validateDiscountPercentage(this)" />
                            <span asp-validation-for="PhanTramGiam" class="text-danger small"></span>
                            <small class="form-text text-muted">Nh·∫≠p gi√° tr·ªã t·ª´ 1% ƒë·∫øn 40%</small>
                        </div>

                        <div class="col-md-4">
                            <label asp-for="NgayBatDau" class="form-label">Ng√†y b·∫Øt ƒë·∫ßu</label>
                            <input asp-for="NgayBatDau" type="datetime-local" class="form-control" />
                            <span asp-validation-for="NgayBatDau" class="text-danger small"></span>
                        </div>

                        <div class="col-md-4">
                            <label asp-for="NgayKetThuc" class="form-label">Ng√†y k·∫øt th√∫c</label>
                            <input asp-for="NgayKetThuc" type="datetime-local" class="form-control" />
                            <span asp-validation-for="NgayKetThuc" class="text-danger small"></span>
                        </div>
                    </div>

                    <input type="hidden" id="selectedChiTietIds" name="selectedIds" />

                    <div class="mt-4 d-flex justify-content-between">
                        <button type="submit" class="btn btn-success px-4"><i class="bi bi-check-circle me-1"></i>T·∫°o</button>
                        <a asp-action="Index" class="btn btn-outline-secondary px-4"><i class="bi bi-x-circle me-1"></i>H·ªßy</a>
                    </div>
                </form>
            </div>
        </div>

        <hr class="my-5" />

        <h4 class="text-primary"><i class="bi bi-box-seam me-2"></i>S·∫£n ph·∫©m</h4>
        <input type="text" id="searchInput" placeholder="üîç T√¨m ki·∫øm s·∫£n ph·∫©m..." class="form-control mb-3" />

        <div class="table-responsive mb-4">
            <table class="table table-striped table-hover border rounded">
                <thead class="table-dark">
                    <tr>
                        <th></th>
                        <th>STT</th>
                        <th>M√£ s·∫£n ph·∫©m</th>
                        <th>T√™n s·∫£n ph·∫©m</th>
                        <th>Tr·∫°ng th√°i</th>
                    </tr>
                </thead>
                <tbody id="productTable"></tbody>
            </table>
        </div>

        <h4 class="text-primary"><i class="bi bi-clipboard-data me-2"></i>Chi ti·∫øt s·∫£n ph·∫©m</h4>
        <div class="table-responsive">
            <table class="table table-bordered align-middle">
                <thead class="table-light">
                    <tr>
                        <th></th>
                        <th>STT</th>
                        <th>T√™n s·∫£n ph·∫©m</th>
                        <th>K√≠ch c·ª°</th>
                        <th>M√†u s·∫Øc</th>
                        <th>H·ªça ti·∫øt</th>
                        <th>Tr·∫°ng th√°i</th>
                    </tr>
                </thead>
                <tbody id="productDetailTable"></tbody>
            </table>
        </div>
    </div>

    @section Scripts {
        <script>
            let selectedChiTietIds = [];
            let allSanPhams = [];

            async function loadSanPhams() {
                const response = await fetch('/Admin/DotGiamGia/GetSanPhams');
                const data = await response.json();
                allSanPhams = data;
                renderSanPhams(data);
            }

            function renderSanPhams(data) {
                const table = document.getElementById('productTable');
                table.innerHTML = '';
                data.forEach((sp, index) => {
                    const row = `<tr onclick="loadChiTietSanPham('${sp.idSanPham}')">
                        <td><input type="radio" name="productSelect" /></td>
                        <td>${index + 1}</td>
                        <td>${sp.maSanPham}</td>
                        <td>${sp.tenSanPham}</td>
                        <td>${sp.trangThai ? '<span class="badge bg-success">Ho·∫°t ƒë·ªông</span>' : '<span class="badge bg-secondary">Ng·ª´ng</span>'}</td>
                    </tr>`;
                    table.innerHTML += row;
                });
            }

            async function loadChiTietSanPham(idSanPham) {
                const response = await fetch(`/Admin/DotGiamGia/GetChiTietSanPham?idSanPham=${idSanPham}`);
                const data = await response.json();

                const table = document.getElementById('productDetailTable');
                table.innerHTML = '';
                data.forEach((ct, index) => {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td><input type="checkbox" value="${ct.idSanPhamChiTiet}" onchange="toggleSelection(this)" /></td>
                        <td>${index + 1}</td>
                        <td>${ct.tenSanPham}</td>
                        <td>${ct.kichCo}</td>
                        <td>${ct.mauSac}</td>
                        <td>${ct.hoaTiet || '-'}</td>
                        <td>${ct.trangThai ? '<span class="badge bg-success">Ho·∫°t ƒë·ªông</span>' : '<span class="badge bg-secondary">Ng·ª´ng</span>'}</td>
                    `;
                    table.appendChild(tr);
                });

                table.scrollIntoView({ behavior: "smooth", block: "start" });
            }

            function toggleSelection(checkbox) {
                const value = checkbox.value;
                if (checkbox.checked) {
                    if (!selectedChiTietIds.includes(value)) {
                        selectedChiTietIds.push(value);
                    }
                } else {
                    selectedChiTietIds = selectedChiTietIds.filter(id => id !== value);
                }
                document.getElementById('selectedChiTietIds').value = selectedChiTietIds.join(',');
            }

            document.getElementById("searchInput").addEventListener("input", function () {
                const keyword = this.value.toLowerCase();
                const filtered = allSanPhams.filter(sp =>
                    sp.tenSanPham.toLowerCase().includes(keyword) ||
                    sp.maSanPham.toLowerCase().includes(keyword)
                );
                renderSanPhams(filtered);
            });

            function generateMaDot() {
                const now = new Date();
                const year = now.getFullYear().toString().slice(-2);
                const month = (now.getMonth() + 1).toString().padStart(2, '0');
                const day = now.getDate().toString().padStart(2, '0');
                const hours = now.getHours().toString().padStart(2, '0');
                const minutes = now.getMinutes().toString().padStart(2, '0');
                const seconds = now.getSeconds().toString().padStart(2, '0');
                const random = Math.floor(Math.random() * 1000).toString().padStart(3, '0');

                const maDot = `DG${year}${month}${day}${hours}${minutes}${seconds}${random}`;
                document.getElementById('MaDot').value = maDot;
            }

            function validateDiscountPercentage(input) {
                const value = parseFloat(input.value);

                if (value < 0) {
                    input.value = 0;
                    alert('Ph·∫ßn trƒÉm gi·∫£m gi√° kh√¥ng ƒë∆∞·ª£c √¢m!');
                    return;
                }

                if (value < 1) {
                    input.value = 1;
                    alert('Ph·∫ßn trƒÉm gi·∫£m gi√° ph·∫£i t·ª´ 1% tr·ªü l√™n!');
                    return;
                }

                if (value > 40) {
                    input.value = 40;
                    alert('Ph·∫ßn trƒÉm gi·∫£m gi√° kh√¥ng ƒë∆∞·ª£c v∆∞·ª£t qu√° 40%!');
                    return;
                }
            }

            document.addEventListener("DOMContentLoaded", () => {
                generateMaDot();
                loadSanPhams();
            });
        </script>
    }
