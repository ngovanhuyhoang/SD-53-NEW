@model dynamic
@{
    ViewData["Title"] = "ĐƠN MUA CỦA TÔI";
    var search = ViewBag.Search as string ?? "";
    var phoneNumber = ViewBag.PhoneNumber as string ?? "";
    var fromDate = ViewBag.FromDate as string ?? "";
    var toDate = ViewBag.ToDate as string ?? "";
    var isAuthenticated = ViewBag.IsAuthenticated as bool? ?? false;
}

<style>
    .order-tabs {
        border-bottom: 2px solid #eee;
        margin-bottom: 30px;
    }
    
    .order-tab {
        padding: 12px 24px;
        border: none;
        background: none;
        color: #666;
        font-weight: 500;
        border-bottom: 3px solid transparent;
        transition: all 0.3s;
    }
    
    .order-tab.active {
        color: #007bff;
        border-bottom-color: #007bff;
    }
    
    .order-tab:hover {
        color: #007bff;
    }
    
    .filter-section {
        background: #f8f9fa;
        padding: 20px;
        border-radius: 8px;
        margin-bottom: 20px;
    }
    
    .order-table {
        background: white;
        border-radius: 8px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    
    .order-table th {
        background: #f8f9fa;
        border: none;
        padding: 15px 10px;
        font-weight: 600;
        color: #333;
    }
    
    .order-table td {
        padding: 15px 10px;
        border: none;
        border-bottom: 1px solid #eee;
        vertical-align: middle;
    }
    
    .status-badge {
        padding: 6px 12px;
        border-radius: 20px;
        font-size: 12px;
        font-weight: 500;
    }
    
    .status-cho-xac-nhan { background: #fff3cd; color: #856404; }
    .status-da-xac-nhan { background: #d1ecf1; color: #0c5460; }
    .status-cho-lay-hang { background: #d4edda; color: #155724; }
    .status-da-lay-hang { background: #cce5ff; color: #004085; }
    .status-cho-giao-hang { background: #d1e7dd; color: #0f5132; }
    .status-dang-giao-hang { background: #d4edda; color: #155724; }
    .status-da-giao { background: #cce5ff; color: #004085; }
    .status-giao-hang-thanh-cong { background: #d1e7dd; color: #0f5132; }
    .status-da-huy { background: #f8d7da; color: #721c24; }
    
    .action-btn {
        padding: 8px 16px;
        border: none;
        border-radius: 6px;
        font-size: 12px;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.3s;
        display: inline-flex;
        align-items: center;
        gap: 6px;
    }
    
    .btn-view {
        background: #007bff;
        color: white;
    }
    
    .btn-view:hover {
        background: #0056b3;
        color: white;
    }
    
    .btn-cancel {
        background: #dc3545;
        color: white;
    }
    
    .btn-cancel:hover {
        background: #c82333;
        color: white;
    }
    
    .pagination-info {
        font-size: 14px;
        color: #666;
    }
    
    .page-link {
        color: #007bff;
        border: 1px solid #dee2e6;
    }
    
    .page-link:hover {
        color: #0056b3;
        background-color: #e9ecef;
        border-color: #dee2e6;
    }
    
    .page-item.active .page-link {
        background-color: #007bff;
        border-color: #007bff;
    }
</style>

<div class="container mt-4">
    <h2 class="mb-4">ĐƠN MUA CỦA TÔI</h2>
    
    <!-- Bộ lọc nâng cao -->
    <div class="filter-section">
        @if (isAuthenticated)
        {
            <!-- Form tìm kiếm cho người dùng đã đăng nhập -->
            <div class="alert alert-success mb-3">
                <i class="bi bi-person-check"></i>
                <strong>Xin chào, @User.Identity.Name!</strong> Dưới đây là đơn hàng của bạn
            </div>
            
            <form method="get" action="@Url.Action("Index")" id="filterForm">
                <div class="row">
                    <!-- Tìm kiếm theo mã đơn hàng -->
                    <div class="col-md-3">
                        <label class="form-label">Mã đơn hàng:</label>
                        <input type="text" class="form-control" name="search" 
                               placeholder="Nhập mã đơn hàng (tùy chọn)" 
                               value="@search">
                    </div>
                    
                    <!-- Lọc theo ngày từ -->
                    <div class="col-md-3">
                        <label class="form-label">Từ ngày:</label>
                        <input type="date" class="form-control" name="fromDate" 
                               value="@fromDate">
                    </div>
                    
                    <!-- Lọc theo ngày đến -->
                    <div class="col-md-3">
                        <label class="form-label">Đến ngày:</label>
                        <input type="date" class="form-control" name="toDate" 
                               value="@toDate">
                    </div>
                </div>
                <div class="row mt-3">
                    <div class="col-12">
                        <button type="submit" class="btn btn-primary">
                            <i class="bi bi-search"></i> Tìm đơn hàng
                        </button>
                        <a href="@Url.Action("Index")" class="btn btn-secondary">
                            <i class="bi bi-x-circle"></i> Xóa bộ lọc
                        </a>
                    </div>
                </div>
            </form>
        }
        else
        {
            <!-- Form tìm kiếm cho khách vãng lai -->
            <div class="alert alert-info mb-3">
                <i class="bi bi-info-circle"></i>
                <strong>Khách vãng lai:</strong> Vui lòng nhập số điện thoại để tìm đơn hàng của bạn
            </div>
            
            <!-- Hiển thị thông báo lỗi validation -->
            @if (!ViewData.ModelState.IsValid)
            {
                <div class="alert alert-danger mb-3">
                    <i class="bi bi-exclamation-triangle"></i>
                    <strong>Lỗi:</strong>
                    <ul class="mb-0">
                        @foreach (var error in ViewData.ModelState.Values.SelectMany(v => v.Errors))
                        {
                            <li>@error.ErrorMessage</li>
                        }
                    </ul>
                </div>
            }
            
            <form method="get" action="@Url.Action("Index")" id="filterForm">
                <div class="row">
                    <!-- Tìm kiếm bằng số điện thoại cho khách vãng lai -->
                    <div class="col-md-4">
                        <label class="form-label">Số điện thoại:</label>
                        <input type="tel" class="form-control" name="phoneNumber" 
                               placeholder="Nhập số điện thoại đặt hàng" 
                               value="@phoneNumber" 
                               pattern="[0-9]{10,11}" 
                               title="Vui lòng nhập số điện thoại hợp lệ (10-11 số)"
                               required>
                        <div class="form-text">Nhập số điện thoại bạn đã dùng khi đặt hàng</div>
                    </div>
                    
                    <!-- Tìm kiếm theo mã đơn hàng -->
                    <div class="col-md-4">
                        <label class="form-label">Mã đơn hàng:</label>
                        <input type="text" class="form-control" name="search" 
                               placeholder="Nhập mã đơn hàng (tùy chọn)" 
                               value="@search">
                        <div class="form-text">Tìm kiếm theo mã đơn hàng cụ thể</div>
                    </div>
                </div>
                <div class="row mt-3">
                    <div class="col-12">
                        <button type="submit" class="btn btn-primary">
                            <i class="bi bi-search"></i> Tìm đơn hàng
                        </button>
                        <a href="@Url.Action("Index")" class="btn btn-secondary">
                            <i class="bi bi-x-circle"></i> Xóa bộ lọc
                        </a>
                    </div>
                </div>
            </form>
        }
    </div>
    
    <!-- Bảng đơn hàng -->
    <div class="table-responsive order-table">
        <table class="table table-hover mb-0">
            <thead>
                <tr>
                    <th>#</th>
                    <th>Mã hóa đơn</th>
                    <th>Tổng giá trị</th>
                    <th>Tiền giảm</th>
                    <th>Trạng thái</th>
                    <th>Loại đơn</th>
                    <th>Ngày đặt</th>
                    <th>Hành động</th>
                </tr>
            </thead>
            <tbody id="orderTableBody">
                @{
                    var hoaDons = Model?.HoaDons as List<QuanApi.Data.HoaDon> ?? new List<QuanApi.Data.HoaDon>();
                    var pagination = Model?.Pagination;
                }
                @if (hoaDons != null && hoaDons.Any())
                {
                    int stt = 1;
                    foreach (var hoaDon in hoaDons.OrderByDescending(h => h.NgayTao))
                    {
                        <tr>
                            <td>@stt</td>
                            <td><strong>@hoaDon.MaHoaDon</strong></td>
                            <td>@hoaDon.TongTien.ToString("N0") ₫</td>
                            <td>@(hoaDon.TienGiam?.ToString("N0") ?? "0") ₫</td>
                            <td>
                                <span class="status-badge status-@hoaDon.TrangThai.ToLower().Replace(" ", "-")">
                                    @GetTrangThaiText(hoaDon.TrangThai)
                                </span>
                            </td>
                            <td>
                                @if (!string.IsNullOrEmpty(hoaDon.DiaChiGiaoHang))
                                {
                                    <span class="badge bg-primary">Online</span>
                                }
                                else
                                {
                                    <span class="badge bg-secondary">Tại quầy</span>
                                }
                            </td>
                            <td>@hoaDon.NgayTao.ToString("dd/MM/yyyy HH:mm")</td>
                            <td>
                                <div class="d-flex gap-2">
                                    @if (hoaDon.TrangThai == "Chờ xác nhận" || hoaDon.TrangThai == "Đã xác nhận" || hoaDon.TrangThai == "Chờ lấy hàng")
                                    {
                                        <button class="action-btn btn-cancel" onclick="cancelOrder('@hoaDon.IDHoaDon')" title="Hủy đơn">
                                            <i class="bi bi-x-circle"></i> Hủy đơn
                                        </button>
                                    }
                                    
                                    @if (hoaDon.TrangThai == "Đang giao hàng")
                                    {
                                        <button class="action-btn btn-view" onclick="viewShippingInfo('@hoaDon.IDHoaDon')" title="Xem thông tin vận chuyển">
                                            <i class="bi bi-truck"></i> Vận chuyển
                                        </button>
                                    }
                                </div>
                            </td>
                        </tr>
                        stt++;
                    }
                }
                else
                {
                    <tr>
                        <td colspan="8" class="text-center py-4">
                            <div class="text-muted">
                                <i class="bi bi-inbox" style="font-size: 3rem;"></i>
                                @if (isAuthenticated)
                                {
                                    <p class="mt-2">Bạn chưa có đơn hàng nào</p>
                                    <p class="text-sm">Hãy mua sắm để có đơn hàng đầu tiên!</p>
                                }
                                else if (!string.IsNullOrEmpty(phoneNumber))
                                {
                                    <p class="mt-2">Không tìm thấy đơn hàng nào cho số điện thoại <strong>@phoneNumber</strong></p>
                                    <p class="text-sm">Vui lòng kiểm tra lại số điện thoại hoặc liên hệ hỗ trợ</p>
                                }
                                else
                                {
                                    <p class="mt-2">Vui lòng nhập số điện thoại để tìm đơn hàng</p>
                                }
                            </div>
                        </td>
                    </tr>
                }
            </tbody>
        </table>
    </div>
    
    <!-- Phân trang -->
    @if (pagination != null)
    {
        <div class="d-flex justify-content-between align-items-center mt-4">
            <div class="pagination-info">
                Hiển thị @(((pagination.CurrentPage - 1) * pagination.PageSize) + 1) - 
                @Math.Min(pagination.CurrentPage * pagination.PageSize, pagination.TotalCount) 
                trong tổng số @pagination.TotalCount đơn hàng
            </div>
            
            <nav aria-label="Phân trang">
                <ul class="pagination pagination-sm mb-0">
                    @if (pagination.HasPreviousPage)
                    {
                        <li class="page-item">
                            <a class="page-link" href="@Url.Action("Index", new { 
                                page = pagination.CurrentPage - 1,
                                search = search,
                                phoneNumber = phoneNumber,
                                fromDate = fromDate,
                                toDate = toDate
                            })">
                                <i class="fas fa-chevron-left"></i>
                            </a>
                        </li>
                    }
                    
                    @{
                        var startPage = Math.Max(1, pagination.CurrentPage - 2);
                        var endPage = Math.Min(pagination.TotalPages, pagination.CurrentPage + 2);
                    }
                    
                    @for (int i = startPage; i <= endPage; i++)
                    {
                        <li class="page-item @(i == pagination.CurrentPage ? "active" : "")">
                            <a class="page-link" href="@Url.Action("Index", new { 
                                page = i,
                                search = search,
                                phoneNumber = phoneNumber,
                                fromDate = fromDate,
                                toDate = toDate
                            })">@i</a>
                        </li>
                    }
                    
                    @if (pagination.HasNextPage)
                    {
                        <li class="page-item">
                            <a class="page-link" href="@Url.Action("Index", new { 
                                page = pagination.CurrentPage + 1,
                                search = search,
                                phoneNumber = phoneNumber,
                                fromDate = fromDate,
                                toDate = toDate
                            })">
                                <i class="fas fa-chevron-right"></i>
                            </a>
                        </li>
                    }
                </ul>
            </nav>
        </div>
    }
</div>

<script>
// Validate số điện thoại cho khách vãng lai
document.addEventListener('DOMContentLoaded', function() {
    const phoneInput = document.querySelector('input[name="phoneNumber"]');
    if (phoneInput) {
        phoneInput.addEventListener('input', function(e) {
            // Chỉ cho phép nhập số
            this.value = this.value.replace(/[^0-9]/g, '');
            
            // Giới hạn độ dài 10-11 số
            if (this.value.length > 11) {
                this.value = this.value.slice(0, 11);
            }
        });
        
        // Validate khi submit form
        const form = document.getElementById('filterForm');
        form.addEventListener('submit', function(e) {
            if (phoneInput && phoneInput.value.trim() === '') {
                e.preventDefault();
                alert('Vui lòng nhập số điện thoại để tìm đơn hàng');
                phoneInput.focus();
                return false;
            }
            
            if (phoneInput && phoneInput.value.length < 10) {
                e.preventDefault();
                alert('Số điện thoại phải có ít nhất 10 số');
                phoneInput.focus();
                return false;
            }
        });
    }
    
    // Validate ngày cho người dùng đã đăng nhập
    const fromDateInput = document.querySelector('input[name="fromDate"]');
    const toDateInput = document.querySelector('input[name="toDate"]');
    
    if (fromDateInput && toDateInput) {
        fromDateInput.addEventListener('change', function() {
            if (toDateInput.value && this.value > toDateInput.value) {
                alert('Ngày bắt đầu không thể lớn hơn ngày kết thúc');
                this.value = '';
            }
        });
        
        toDateInput.addEventListener('change', function() {
            if (fromDateInput.value && this.value < fromDateInput.value) {
                alert('Ngày kết thúc không thể nhỏ hơn ngày bắt đầu');
                this.value = '';
            }
        });
    }
});

// Hủy đơn hàng
function cancelOrder(orderId) {
    // Hiển thị form nhập lý do hủy đơn
    const lyDo = prompt('Vui lòng nhập lý do hủy đơn hàng:');
    
    if (lyDo === null) {
        // Người dùng nhấn Cancel
        return;
    }
    
    if (lyDo.trim() === '') {
        alert('Vui lòng nhập lý do hủy đơn hàng!');
        return;
    }
    
    if (confirm('Bạn có chắc muốn hủy đơn hàng này?')) {
        fetch(`/DonHang/HuyDon/${orderId}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                LyDoHuyDon: lyDo.trim()
            })
        })
        .then(response => response.json())
        .then(result => {
            if (result.success) {
                alert('Đã hủy đơn hàng thành công!');
                location.reload();
            } else {
                alert(result.message || 'Không thể hủy đơn hàng');
            }
        })
        .catch(error => {
            console.error('Lỗi:', error);
            alert('Có lỗi xảy ra khi hủy đơn hàng');
        });
    }
}

// Xem thông tin vận chuyển
async function viewShippingInfo(orderId) { 
    alert('Đơn hàng sẽ đến tay bạn từ 3-5 ngày');  
}
</script>

@functions {
    public string GetTrangThaiText(string trangThai)
    {
        return trangThai switch
        {
            "Chờ xác nhận" => "Chờ xác nhận",
            "Đã xác nhận" => "Đã xác nhận",
            "Chờ lấy hàng" => "Chờ lấy hàng",
            "Đã lấy hàng" => "Đã lấy hàng",
            "Chờ giao hàng" => "Chờ giao hàng",
            "Đang giao hàng" => "Đang giao hàng",
            "Đã giao" => "Đã giao",
            "Giao hàng thành công" => "Hoàn thành",
            "Đã hủy" => "Đã hủy",
            _ => trangThai
        };
    }
}
